<!DOCTYPE html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    


    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="一段有趣的C程序（续）"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@googollee"/>



  	<meta property="og:title" content="一段有趣的C程序（续） &middot; Air on G" />
  	<meta property="og:site_name" content="Air on G" />
  	<meta property="og:url" content="http://air.googol.im/post/analysis-of-occ-circle/" />
    
    
        
            <meta property="og:image" content="http://air.googol.im/images/cover.jpg"/>
        
    

    
    <meta property="og:description" content="" />
  	<meta property="og:type" content="article" />
    <meta property="og:image" content="http://air.googol.im/" />
    <meta property="article:published_time" content="2004-09-23T20:00:00&#43;08:00" />

    
    <meta property="article:tag" content="c" />
    
    <meta property="article:tag" content="occ" />
    
    

    <title>一段有趣的C程序（续） &middot; Air on G</title>

    
    <meta name="description" content="" />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://air.googol.im/images/favicon.ico">
	  <link rel="apple-touch-icon" href="http://air.googol.im/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="http://air.googol.im/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="http://air.googol.im/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />

    

    
      
          <link href="http://air.googol.im/index.xml" rel="alternate" type="application/rss+xml" title="Air on G" />
      
      
    
    <meta name="generator" content="Hugo 0.16-DEV" />

    <link rel="canonical" href="http://air.googol.im/post/analysis-of-occ-circle/" />

    
      
    

    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/">Blog</a>
            </li>
        
            <h3>Follow me</h3>
            <li class="nav-opened" role="presentation">
            	<a href="https://github.com/googollee">Github repos</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://twitter.com/googollee">Twitter timeline</a>
            </li>
        
    </ul>
    
    
    <a class="subscribe-button icon-feed" href="http://air.googol.im/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
  
      <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">一段有趣的C程序（续）</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2004-09-23T20:00:00&#43;08:00">
            Sep 23, 2004
          </time>
        
         
          <span class="post-tag small"><a href="http://air.googol.im/tags/c/">#c</a></span>
         
          <span class="post-tag small"><a href="http://air.googol.im/tags/occ/">#occ</a></span>
         
        </section>
    </header>

    <section class="post-content">
      <p>同学看完我的一段有趣的程序后，给了我一段bt的程序：</p>

<pre><code class="language-c">#define _ -F&lt;00||--F-OO--;
int F=00,OO=00;main(){F_OO();printf(&quot;%1.3f\n&quot;,4.*-F/OO/OO);}F_OO()
{
            _-_-_-_
       _-_-_-_-_-_-_-_-_
    _-_-_-_-_-_-_-_-_-_-_-_
  _-_-_-_-_-_-_-_-_-_-_-_-_-_
 _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
 _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
 _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
 _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
  _-_-_-_-_-_-_-_-_-_-_-_-_-_
    _-_-_-_-_-_-_-_-_-_-_-_
        _-_-_-_-_-_-_-_
            _-_-_-_
}
</code></pre>

<!-- more -->

<p>俺就又本着人不bt枉少年的精神，又bt的研究了一下。程序贴到vc里，编译出现三个错误，一个是printf未定义，一个是F_00未定义。改动后如下，同时将程序结构改的可读性更强：</p>

<pre><code class="language-c">#include&lt;stdio.h&gt;
#define _ -F&lt;00||--F-OO--;
F_OO();

int F=00,OO=00;

main(){
    F_OO();
    printf(&quot;%1.3f\n&quot;,4.*-F/OO/OO);
}

F_OO()
{
            _-_-_-_
       _-_-_-_-_-_-_-_-_
    _-_-_-_-_-_-_-_-_-_-_-_
  _-_-_-_-_-_-_-_-_-_-_-_-_-_
 _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
 _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
 _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
 _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
  _-_-_-_-_-_-_-_-_-_-_-_-_-_
    _-_-_-_-_-_-_-_-_-_-_-_
        _-_-_-_-_-_-_-_
            _-_-_-_
}
</code></pre>

<p>首先，这个程序bt到用00和OO近似来混淆视听！OO是两个大写字母o，可以作为变量名，而00单独写只是数字0，不能作为变量名。</p>

<p>程序首先定义了一段宏<code>_</code>（md，又是这个下划线），之后定义了两个变量F和OO，并赋予初值0。这里要注意，宏里使用到的就是这两个变量。</p>

<p>之后定义了一个函数F_00()，大量调用了这个宏，来改变变量F和OO的值。虽然程序看起来bt，但实际上归结起来只有两种语句“<code>_</code>”和“<code>-_</code>”两种。这两语句在进行宏替换后分别为“<code>-F&lt;00||--F-OO--;</code>”和“<code>--F&lt;00||--F-OO--;</code>”</p>

<p>语句“<code>-F&lt;00||--F-OO--;</code>”根据优先级判断，先执行<code>||</code>左边的部分，由于F=0，所以左部分为假（0&lt;0为假），在执行右半部分，先对F自减1，执行<code>F-OO</code>，再对OO自减1。最后的结果为-1，再进行<code>||</code>，舍弃最后结果。折腾半天，只有对F和OO的自减使变量发生了变化，最终的运算结果并不care。</p>

<p>语句“<code>--F&lt;00||--F-OO--;</code>”根据优先级判断，先执行<code>||</code>左边部分，对F自减1后判断是否F&lt;0。经过上个语句后，F值为-1，因此F&lt;0为真，不再执行右半部分。</p>

<p>但是注意！*在单步跟踪“<code>-_</code>”语句时，变量的值没有发生任何变化！*也就是说刚才的分析并不是实际情况。由于变量值没有任何改变，可以肯定<code>||</code>右边的部分根本没有被运行，也就是说<code>||</code>左边的部分结果为真。如果左边的语句解释为“<code>- -F&lt;00</code>”（注意两个减号中间的空格），则F的值没有被改变，且其值为真。因此，这里的“<code>-_</code>”语句实际是被解释成“<code>- -F&lt;00||--F-OO--;</code>”，也就是“<code>(-(-F))&lt;00||--F-OO--;</code>”。</p>

<p>由于“<code>-_</code>”没有对变量的值进行任何操作，因此函数<code>F_00()</code>里看似唬人的大球，实际每行只有行首的“<code>_</code>”语句起作用，是对两个变量的值自减1。因此，整个高度为16的球，实际对两个变量进行16次自减1。真是无聊！！！！！</p>

<p>主程序就简单多了。首先运行<code>F_00()</code>改变两个变量的值，最后运行<code>printf(&quot;%1.3f\n&quot;,4.*-F/OO/OO)</code>语句输出。这个printf语句就简单了，输出一个长度为1，3位小数宽度的浮点数并换行。因为浮点的总长度肯定大于1，所以相当于输出一个3位小数宽的浮点并换行。输出的浮点内容为“<code>4.*-F/OO/OO</code>”，也就是“<code>(4.)*(-F)/OO/OO</code>”，此时F和OO的值都是“-16”，结果很显然，没啥大意思了。</p>

<p>前面所讲到的问题，应该涉及到c语言编译器实现的细节问题。c语言编译器指对宏进行简单替换，而不进行任何语法判断，因此可以肯定，对宏的替换工作是先于语法判断和编译过程的。c编译器在进行语法判断时，使用的是大嘴原则，也就是尽可能将更多的字符解释为运算符等关键字，而实际中并没有将“<code>-_</code>”解释为“<code>--F&lt;00||--F-OO--;</code>”，可以认为，编译器在替换前，会对宏的前后进行标识，将宏本身与前后的语句分开，这样，宏本身的运算符就不会与程序前后的运算符关联在一起，改变宏语句本身的运算符的意义。因此，这个程序中的宏最终解释为“<code>- -F&lt;00||--F-OO--;</code>”。</p>

<p>另一个值得注意的问题是，“<code>-_</code>”在解释为“<code>- -F&lt;00||--F-OO--;</code>”之后，实际宏本身的运算顺序已经改变。这里也是为什么在《c陷阱与缺陷》里，作者特别提到，宏的定义应该加括号，格式为“#define NN (&hellip;)”，以免程序中出现很隐蔽的，改变宏本身运算顺序的逻辑错误。</p>

<p>为了验证编译器对宏的替换过程，编写了下面的程序：</p>

<pre><code class="language-c">#define A ++a
void main(void){
 int a=0;
 a=a+++A;
}
</code></pre>

<p>实际程序运行通过，证明“<code>a=a+++A</code>”被解释为“<code>a=a+++ ++a</code>”即“<code>a=(a++)+(++a)</code>”，而不是“<code>a=a+++++a</code>”。其中后一种译法会因为大嘴原则译为“<code>a=((a++) ++)+a</code>”第二层的“<code>++</code>”会因为左边不是一个有效变量，而引起编译错误：<code>error C2105: '++' needs l-value</code>。</p>

    </section>


  <footer class="post-footer">


    

    





<section class="author">
  <h4><a href="http://air.googol.im/">Googol Lee</a></h4>
  
  <p>多年生软件工程师，信仰开源</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Munich, Germany</span>
    <span class="author-link icon-link"><a href="http://air.googol.im">http://air.googol.im</a></span>
  </div>
</section>



    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=%e4%b8%80%e6%ae%b5%e6%9c%89%e8%b6%a3%e7%9a%84C%e7%a8%8b%e5%ba%8f%ef%bc%88%e7%bb%ad%ef%bc%89&nbsp;-&nbsp;Air%20on%20G&amp;url=http%3a%2f%2fair.googol.im%2fpost%2fanalysis-of-occ-circle%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fair.googol.im%2fpost%2fanalysis-of-occ-circle%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-pinterest" style="font-size: 1.4em" href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fair.googol.im%2fpost%2fanalysis-of-occ-circle%2f&amp;description=%e4%b8%80%e6%ae%b5%e6%9c%89%e8%b6%a3%e7%9a%84C%e7%a8%8b%e5%ba%8f%ef%bc%88%e7%bb%ad%ef%bc%89"
      onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
      <span class="hidden">Pinterest</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=http%3a%2f%2fair.googol.im%2fpost%2fanalysis-of-occ-circle%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    

<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'air-g';
  var disqus_url = 'http:\/\/air.googol.im\/post\/analysis-of-occ-circle\/';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Air on G</a> 除非另有声明，本网站采用<a href='https://creativecommons.org/licenses/by-nd/3.0/cn/'>知识共享“署名-禁止演绎 3.0 中国大陆”许可协议</a>授权。</section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="http://air.googol.im/js/jquery.js"></script>
    <script type="text/javascript" src="http://air.googol.im/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="http://air.googol.im/js/index.js"></script>
    
</body>
</html>

