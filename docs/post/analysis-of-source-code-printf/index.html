<!DOCTYPE html>
<html lang="zh">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  
  
  
  
  
  <link rel="prev" href="https://air.googol.im/post/analysis-of-occ-circle/" />
  <link rel="next" href="https://air.googol.im/post/mod-3/" />
  <link rel="canonical" href="https://air.googol.im/post/analysis-of-source-code-printf/" />
  <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           内核printf源代码分析 | Air on G
       
  </title>
  <meta name="title" content="内核printf源代码分析 | Air on G">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="内核printf源代码分析"/>
<meta name="twitter:description" content="对VC里printf的实现的分析。"/>

  <script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "内核printf源代码分析",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/air.googol.im\/post\/analysis-of-source-code-printf\/"
  },
  "image": {
    "@type": "ImageObject",
    "url": "https:\/\/air.googol.im\/cover.png",
    "width":  800 ,
    "height":  600 
  },
  "genre": "post",
  "keywords": "c, printf",
  "wordcount":  1940 ,
  "url": "https:\/\/air.googol.im\/post\/analysis-of-source-code-printf\/",
  "datePublished": "2004-10-18T20:00:00\u002b08:00",
  "dateModified": "2004-10-18T20:00:00\u002b08:00",
  "license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.",
  "publisher": {
    "@type": "Organization",
    "name": "Googol Lee",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/air.googol.im\/logo.png",
      "width":  127 ,
      "height":  40 
    }
  },
  "author": {
    "@type": "Person",
    "name": "Googol Lee"
  },
  "description": ""
}
</script>
</head>

  



  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="https://air.googol.im">Air on G</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/post" title="">Blog</a>
                
                <a class="menu-item" href="/categories" title="">Categories</a>
                
                <a class="menu-item" href="/about" title="">About</a>
                
                <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-sun"></i></a>&nbsp;
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-sun"></i></a>&nbsp;<a href="https://air.googol.im">Air on G</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/post" title="">Blog</a>
                
                <a class="menu-item" href="/categories" title="">Categories</a>
                
                <a class="menu-item" href="/about" title="">About</a>
                
        </div>
    </div>
</nav>

    	 <main class="main">
          <div class="container">
      		
<article class="post-warp">
    <header class="post-header">
        <h1 class="post-title">内核printf源代码分析</h1>
        <div class="post-meta">
              <a href="https://air.googol.im" rel="author">Googol Lee</a>  ♥ 
                <span class="post-time">
                     <time datetime=2004-10-18 >2004-10-18</time>
                </span>
                
                
                <i class="iconfont icon-timer"></i>
                4 min
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <p>对VC里printf的实现的分析。</p>
<p>在stdio.c里找到了printf的实现代码.首先看看对printf的定义:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">printf</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cntrl_string, ...)
</span></span></code></pre></div><p>第一个参数cntrl_string是控制字符串,也就是平常我们写入%d,%f的地方.紧接着后面是一个变长参数.</p>
<p>看看函数头部的定义:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> pos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, cnt_printed_chars <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, i;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> chptr;
</span></span><span style="display:flex;"><span>  va_list ap;
</span></span></code></pre></div><p>马上晕!除了ap我们可以马上判断出来是用来读取变长参数的,i用于循环变量.其他变量都不知道是怎么回事.不要着急,我们边看代码边分析.代码的第一行必然是</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">va_start</span> (ap, cntrl_string);
</span></span></code></pre></div><p>用来初始化变长参数.</p>
<p>接下来是一个while循环</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (cntrl_string[pos]) {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>结束条件是cntrl_string[pos]为NULL,显然这个循环是用来遍历整个控制字符串的.自然pos就是当前遍历到的位置了.进入循环首先闯入视线的是</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (cntrl_string[pos] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;%&#39;</span>) {
</span></span><span style="display:flex;"><span>     pos<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>     ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>开门见山,上来就当前字符是否办断是否%.一猜就知道如果成立pos++马上取出下一个字符在d,f,l等等之间进行判断.往下一看,果真不出所料:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">switch</span> (cntrl_string[pos]) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;c&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;s&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;i&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;d&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;u&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>用上switch-case了. 快速浏览一下下面的代码.</p>
<p>首先看看case &lsquo;c&rsquo;的部分</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;c&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">putchar</span> (<span style="color:#a6e22e">va_arg</span> (ap, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>));
</span></span><span style="display:flex;"><span> cnt_printed_chars<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">break</span>;
</span></span></code></pre></div><p>%c表示仅仅输出一个字符.因此先通过va_arg进行参数的类型转换,之后用putchar[1]输出到屏幕上去.之后是cnt_printed_chars++,通过这句我们就可以判断出cnt_printed_chars使用来表示,已经被printf输出的字符个数的.</p>
<p>再来看看 case &rsquo;s&rsquo;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;s&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> chptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">va_arg</span> (ap, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">while</span> (chptr [i]) {
</span></span><span style="display:flex;"><span>   cnt_printed_chars<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">putchar</span> (chptr [i<span style="color:#f92672">++</span>]);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">break</span>;
</span></span></code></pre></div><p>和case &lsquo;c&rsquo;,同出一辙.cnt_printed_chars++放在了循环内,也证明了刚才提到的他的作用.另外我们也看到了cnptr是用来在处理字符串时的位置指针.到此为止,我们清楚的所有变量的用途,前途变得更加光明了.</p>
<p>接下来:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// PartI
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;i&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;d&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#a6e22e">printInt</span> (<span style="color:#a6e22e">va_arg</span> (ap, <span style="color:#66d9ef">int</span>));
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;u&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#a6e22e">printUnsignedInt</span> (<span style="color:#a6e22e">va_arg</span> (ap, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>));
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;x&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#a6e22e">printHexa</span> (<span style="color:#a6e22e">va_arg</span> (ap, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>), <span style="color:#e6db74">&#39;x&#39;</span>);
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;X&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#a6e22e">printHexa</span> (<span style="color:#a6e22e">va_arg</span> (ap, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>), <span style="color:#e6db74">&#39;X&#39;</span>);
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;o&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#a6e22e">printOctal</span> (<span style="color:#a6e22e">va_arg</span> (ap, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>));
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Part II
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;p&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">putchar</span> (<span style="color:#e6db74">&#39;0&#39;</span>);
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">putchar</span> (<span style="color:#e6db74">&#39;x&#39;</span>);
</span></span><span style="display:flex;"><span> cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>; <span style="color:#75715e">/* of &#39;0x&#39; */</span>
</span></span><span style="display:flex;"><span> cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#a6e22e">printHexa</span> (<span style="color:#a6e22e">va_arg</span> (ap, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>), <span style="color:#e6db74">&#39;x&#39;</span>);
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;#&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> pos<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">switch</span> (cntrl_string[pos]) {
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;x&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">putchar</span> (<span style="color:#e6db74">&#39;0&#39;</span>);
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">putchar</span> (<span style="color:#e6db74">&#39;x&#39;</span>);
</span></span><span style="display:flex;"><span>   cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>; <span style="color:#75715e">/* of &#39;0x&#39; */</span>
</span></span><span style="display:flex;"><span>   cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#a6e22e">printHexa</span> (<span style="color:#a6e22e">va_arg</span> (ap, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>), <span style="color:#e6db74">&#39;x&#39;</span>);
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;X&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">putchar</span> (<span style="color:#e6db74">&#39;0&#39;</span>);
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">putchar</span> (<span style="color:#e6db74">&#39;X&#39;</span>);
</span></span><span style="display:flex;"><span>   cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>; <span style="color:#75715e">/* of &#39;0X&#39; */</span>
</span></span><span style="display:flex;"><span>   cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#a6e22e">printHexa</span> (<span style="color:#a6e22e">va_arg</span> (ap, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>), <span style="color:#e6db74">&#39;X&#39;</span>);
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;o&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">putchar</span> (<span style="color:#e6db74">&#39;0&#39;</span>);
</span></span><span style="display:flex;"><span>   cnt_printed_chars<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>   cnt_printed_chars <span style="color:#f92672">+=</span> <span style="color:#a6e22e">printOctal</span> (<span style="color:#a6e22e">va_arg</span> (ap, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>));
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">break</span>;
</span></span></code></pre></div><p>注意观察一下,PartII的代码其实就是比PartI的代码多一个样式.在16进制数或八进制前加入0x或是o,等等.因此这里就只分析一下PartI咯.</p>
<p>其实仔细看看PartI的个条case,也就是把参数分发到了更具体的函数用于显示,然后以返回值的形式返回输出个数.对于这些函数就不具体分析了.我们先来看看一些善后处理:</p>
<p>先看case的default处理.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">putchar</span> ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>) cntrl_string[pos]);
</span></span><span style="display:flex;"><span> cnt_printed_chars<span style="color:#f92672">++</span>;
</span></span></code></pre></div><p>就是直接输出cntrl_string里%号后面的未知字符.应该是一种容错设计处理.</p>
<p>再看看if (cntrl_string[pos] == &lsquo;%&rsquo;)的else部分</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">putchar</span> ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>) cntrl_string[pos]);
</span></span><span style="display:flex;"><span>      cnt_printed_chars<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      pos<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><p>如果不是%开头的,那么直接输出这个字符.</p>
<p>最后函数返回前</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#a6e22e">va_end</span> (ap);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> cnt_printed_chars;
</span></span></code></pre></div><p>va_end处理变长参数的善后工作.并返回输出的字符个数.</p>
<p>在最后我们有必要谈谈putChar函数以及基本输出的基础函数printChar,先来看看putChar</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">putchar</span> (<span style="color:#66d9ef">int</span> c) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>) c) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;\n&#39;</span> <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">newLine</span> ();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;\r&#39;</span> <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">carriageReturn</span> ();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;\f&#39;</span> <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">clearScreen</span> ();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;\t&#39;</span> <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printChar</span> (<span style="color:#ae81ff">32</span>); <span style="color:#a6e22e">printChar</span> (<span style="color:#ae81ff">32</span>); <span style="color:#75715e">/* 32 = space */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printChar</span> (<span style="color:#ae81ff">32</span>); <span style="color:#a6e22e">printChar</span> (<span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printChar</span> (<span style="color:#ae81ff">32</span>); <span style="color:#a6e22e">printChar</span> (<span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printChar</span> (<span style="color:#ae81ff">32</span>); <span style="color:#a6e22e">printChar</span> (<span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;\b&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">backspace</span> ();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;\a&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">beep</span> ();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">default</span> <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printChar</span> ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>) c);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> c;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>通览一下,也是switch-case为主体的.主要是用来应对一些特殊字符,如\n,\r,&hellip;.这里需要提一下,关于\t的理解.有些人认为\t就是8个space,有些人则认为,屏幕分为10大列(每个大列8个小列总共80列).一个\t就跳到下一个大列输出.也就是说不管你现在实在屏幕的第1,2,3,4,5,6,7位置输出字符,只要一个\t都在第8个位置开始输出. VS.NET中就是用的这种理解.因此如果按照这个理解的话,\t的实现可以这样</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> currentX <span style="color:#f92672">=</span> ((currentX <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>;
</span></span></code></pre></div><p>然后在currentX位置输出.</p>
<p>接下来看printChar也就是输出部分最低层的操作咯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printChar</span> (<span style="color:#66d9ef">const</span> byte ch) {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(word <span style="color:#f92672">*</span>)(VIDEO <span style="color:#f92672">+</span> y <span style="color:#f92672">*</span> <span style="color:#ae81ff">160</span> <span style="color:#f92672">+</span> x <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">=</span> ch <span style="color:#f92672">|</span> (fill_color <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>  x<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (x <span style="color:#f92672">&gt;=</span> WIDTH)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">newLine</span> ();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setVideoCursor</span> (y, x);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里VIDEO表示显存地址也就是0xB8000.通过<code>y * 160 + x</code>屏幕<code>(x,y)</code>坐标在显存中的位置.这里需要知道,一个字符显示需要两个字节,一个是ASCII码,第二个是字符属性代码也就是颜色代码.因此才必须<code>y * 80 * 2 + x = y * 160 + x</code>.那么<code>ch | (fill_color &lt;&lt; 8)</code>也自然就是写入字符及属性代码用的了.每写一个字符光标位置加1,如果大于屏幕宽度WIDTH就换行.最后通过setVideoCursor设置新的光标位置.完成了整个printChar过程.</p>
<p>到此,把printf从上到下说了一遍.不知道各位大家感觉如何,如果说得不清楚还大家多提意见.有说得不对的地方请大家多多指教.</p>
    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>:</span>
                <span>Googol Lee </span>
                </p>
            
           
            <p class="copyright-item">
                    <span>:</span>
                   <span>1940</span>
            </p>

            <p class="copyright-item">
                
                <span>:</span>
                <span>

      
        <a href="//twitter.com/share?url=https%3a%2f%2fair.googol.im%2fpost%2fanalysis-of-source-code-printf%2f&amp;text=%e5%86%85%e6%a0%b8printf%e6%ba%90%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90&amp;via=googollee" target="_blank" title="Share on Twitter">
          <i class="iconfont icon-twitter"></i>
        </a>
        
      
      
      
      
      
      
      
      
        
      
        
      

          

          

          

          

</span>
                
            </p>

             
            <p class="copyright-item">
                Released under <a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a>
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-icon-tag"></i>: 
            
            <span class="tag"><a href="https://air.googol.im/tags/c/">
                    #c</a></span>
            
            <span class="tag"><a href="https://air.googol.im/tags/printf/">
                    #printf</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();"></a></span> · 
                <span><a href="https://air.googol.im"></a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://air.googol.im/post/analysis-of-occ-circle/" class="prev" rel="prev" title="一段有趣的C程序（续）"><i class="iconfont icon-dajiantou"></i>&nbsp;一段有趣的C程序（续）</a>
         
        
        <a href="https://air.googol.im/post/mod-3/" class="next" rel="next" title="求3的余数">求3的余数&nbsp;<i class="iconfont icon-xiaojiantou"></i></a>
        
    </div>

    <div class="post-comment">
          
          <div id="disqus_thread"></div>
  <script type="text/javascript">
      (function() {
          
          
          if (window.location.hostname == "localhost")
              return;
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          var disqus_shortname = 'air-g';
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

 

          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2004 - 2023</span>
        
         
            <span class="author" itemprop="copyrightHolder"><a href="https://air.googol.im">Googol Lee</a> | </span>
         

		  <span>Crafted with ❤️ by <a href="https://github.com/Fastbyte01/KeepIt" target="_blank" rel="external nofollow noopener noreffer">KeepIt</a> & <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a></span>
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  





<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-BX4XDRKHQ9', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



     </div>
  </body>
</html>
