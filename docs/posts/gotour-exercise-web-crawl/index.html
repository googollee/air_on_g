<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>关于gotour最后一题的一些想法 | Air On G</title><meta name=keywords content="golang"><meta name=description content="过年几天，把A Tour of Go看了一遍，算是复习了一遍go语言。其中最后一题Exercise: Web Crawler有些复杂，是串行程序转换到并行时常见的问题。这里记录一些当时思考的结果。"><meta name=author content="Googol Lee"><link rel=canonical href=https://air.googol.im/posts/gotour-exercise-web-crawl/><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=https://air.googol.im/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://air.googol.im/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://air.googol.im/favicon-32x32.png><link rel=apple-touch-icon href=https://air.googol.im/apple-touch-icon.png><link rel=mask-icon href=https://air.googol.im/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://air.googol.im/posts/gotour-exercise-web-crawl/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-BX4XDRKHQ9"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BX4XDRKHQ9")}</script><meta property="og:url" content="https://air.googol.im/posts/gotour-exercise-web-crawl/"><meta property="og:site_name" content="Air On G"><meta property="og:title" content="关于gotour最后一题的一些想法"><meta property="og:description" content="过年几天，把A Tour of Go看了一遍，算是复习了一遍go语言。其中最后一题Exercise: Web Crawler有些复杂，是串行程序转换到并行时常见的问题。这里记录一些当时思考的结果。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-02-04T20:00:00+08:00"><meta property="article:modified_time" content="2012-02-04T20:00:00+08:00"><meta property="article:tag" content="Golang"><meta name=twitter:card content="summary"><meta name=twitter:title content="关于gotour最后一题的一些想法"><meta name=twitter:description content="过年几天，把A Tour of Go看了一遍，算是复习了一遍go语言。其中最后一题Exercise: Web Crawler有些复杂，是串行程序转换到并行时常见的问题。这里记录一些当时思考的结果。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://air.googol.im/posts/"},{"@type":"ListItem","position":2,"name":"关于gotour最后一题的一些想法","item":"https://air.googol.im/posts/gotour-exercise-web-crawl/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"关于gotour最后一题的一些想法","name":"关于gotour最后一题的一些想法","description":"过年几天，把A Tour of Go看了一遍，算是复习了一遍go语言。其中最后一题Exercise: Web Crawler有些复杂，是串行程序转换到并行时常见的问题。这里记录一些当时思考的结果。\n","keywords":["golang"],"articleBody":"过年几天，把A Tour of Go看了一遍，算是复习了一遍go语言。其中最后一题Exercise: Web Crawler有些复杂，是串行程序转换到并行时常见的问题。这里记录一些当时思考的结果。\n原题 将下面的网页抓取程序，由串行改为并行。修改Crawl函数，并发抓取url指向的页面，并且保证对同一页面只做一次抓去。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 package main import ( \"os\" \"fmt\" ) type Fetcher interface { // Fetch returns the body of URL and // a slice of URLs found on that page. Fetch(url string) (body string, urls []string, err os.Error) } // Crawl uses fetcher to recursively crawl // pages starting with url, to a maximum of depth. func Crawl(url string, depth int, fetcher Fetcher) { // TODO: Fetch URLs in parallel. // TODO: Don't fetch the same URL twice. // This implementation doesn't do either: if depth \u003c= 0 { return } body, urls, err := fetcher.Fetch(url) if err != nil { fmt.Println(err) return } fmt.Printf(\"found: %s %q\\n\", url, body) for _, u := range urls { Crawl(u, depth-1, fetcher) } return } func main() { Crawl(\"http://golang.org/\", 4, fetcher) } // fakeFetcher is Fetcher that returns canned results. type fakeFetcher map[string]*fakeResult type fakeResult struct { body string urls []string } func (f *fakeFetcher) Fetch(url string) (string, []string, os.Error) { if res, ok := (*f)[url]; ok { return res.body, res.urls, nil } return \"\", nil, fmt.Errorf(\"not found: %s\", url) } // fetcher is a populated fakeFetcher. var fetcher = \u0026fakeFetcher{ \"http://golang.org/\": \u0026fakeResult{ \"The Go Programming Language\", []string{ \"http://golang.org/pkg/\", \"http://golang.org/cmd/\", }, }, \"http://golang.org/pkg/\": \u0026fakeResult{ \"Packages\", []string{ \"http://golang.org/\", \"http://golang.org/cmd/\", \"http://golang.org/pkg/fmt/\", \"http://golang.org/pkg/os/\", }, }, \"http://golang.org/pkg/fmt/\": \u0026fakeResult{ \"Package fmt\", []string{ \"http://golang.org/\", \"http://golang.org/pkg/\", }, }, \"http://golang.org/pkg/os/\": \u0026fakeResult{ \"Package os\", []string{ \"http://golang.org/\", \"http://golang.org/pkg/\", }, }, } 程序有些长有些长，因为还包括一部分假数据。程序入口在func main里，提供\"http://golang.org/\"作为起始页面，抓取深度是4，使用fetcher作为抓取算法。\n第一次并行化 最初的想法是让每个Crawl单独跑一个goroutine，当Crawl里抓到新的url时，就启动一个新的goroutine。这个改动很简单，只需要修改Crawl函数就行：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func Crawl(url string, depth int, fetcher Fetcher) { if depth \u003c= 0 { return } body, urls, err := fetcher.Fetch(url) if err != nil { fmt.Println(err) return } fmt.Printf(\"found: %s %q\\n\", url, body) for _, u := range urls { go Crawl(u, depth-1, fetcher) } return } 但实际结果却是只打印最初的一条“http://golang.org/”就结束了。因为go的程序在终止时，并不等待其余goroutine的结束，Crawl内用go Crawl(...)的方式递归调用后，main并不等待新建的goroutine的结束，就结束了整个程序，因此其余的url还没有抓取，就结束了。\n监视goroutine的启动和退出 因此，程序需要有办法监控总共启动了多少个goroutine，而且还要能知道，是否所有goroutine都已经运行完毕退出了。传统的并发程序，是通过thread id或者thread handler，配合类似join的api来完成的。但是go没有任何对goroutine的控制方法，要想知道goroutine的状态，只能在其内部，通过chan将状态发送给接收者。同时，为了方便对goroutine进行计数，最好将所有goroutine的启动放在一个函数内，这就需要Crawl将新抓到的url发到一个特殊的控制函数，这个控制函数在接收到新的url后，启动新的Crawl进行抓取。程序修改如下：\n新建一个UrlData结构，用来传递新抓到的url，以及这个url对应的抓取深度depth：\n1 2 3 4 type UrlData struct { url string depth int } 修改Crawl函数，加入两个chan，quit对应函数退出的信号，urldata对应抓取到新的url时的新数据传输通道。注意defer是如何间接明了的完成发送quit信号的功能的（对比C++的析构函数概念，defer要清晰明快的多，而且有closure的加持，能做的事情也比析构多）：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func Crawl(url string, depth int, fetcher Fetcher, urldata chan\u003c- *UrlData, quit chan\u003c- int) { defer func() { quit \u003c- 1 }() if depth \u003c= 0 { return } body, urls, err := fetcher.Fetch(url) if err != nil { fmt.Println(err) return } fmt.Printf(\"found: %s %q\\n\", url, body) for _, u := range urls { urldata \u003c- \u0026UrlData{u, depth-1} } return } 修改main函数，加入对goroutine的控制：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func main() { urldata := make(chan *UrlData) quit := make(chan int) go Crawl(\"http://golang.org/\", 4, fetcher, urldata, quit) for i:=1; i\u003e0; { select { case \u003c-quit: i-- case url := \u003c-urldata: go Crawl(url.url, url.depth, fetcher, urldata, quit) i++ } } } 这样，整个程序在流程上就没有问题了。\n加入cache，对同一网址只Crawl一遍 因为所有Crawl都是由main函数控制的，因此这个改动只在main里修改即可：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func main() { urldata := make(chan *UrlData) quit := make(chan int) url_cache := make(map[string]bool) url_cache[\"http://golang.org/\"] = true go Crawl(\"http://golang.org/\", 4, fetcher, urldata, quit) for i:=1; i\u003e0; { select { case \u003c-quit: i-- case url := \u003c-urldata: if url_cache[url.url] { break } url_cache[url.url] = true go Crawl(url.url, url.depth, fetcher, urldata, quit) i++ } } } url_cache是一个key为string，value为bool的map，在有新的url传入时，先以url为key，检查其value是否为true。如果为true说明已经Crawl过，不再处理，如果为false，先将value设置为true，然后启动Crawl对这个url进行抓取。\n重构，DRY 你注意到了么？main函数里有两个地方对url_cache进行操作并启动Crawl。一个是在for循环外面，设置启动url，另一个是在for循环里面，处理新的url。这两个地方所做的事情，本质上都是对一个新url的处理，但为什么要写两遍呢？现在就来试试能不能将其合并：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func main() { urldata := make(chan *UrlData) quit := make(chan int) url_cache := make(map[string]bool) go func() { urldata \u003c- \u0026UrlData{\"http://golang.org/\", 4} }() Loop: for i := 0; ; { select { case \u003c-quit: i-- if i == 0 { break Loop } case url := \u003c-urldata: if url_cache[url.url] { break } url_cache[url.url] = true go Crawl(url.url, url.depth, fetcher, urldata, quit) i++ } } } 利用已有的urldata chan，将初始url和depth作为参数传入，就可以去掉for外面的Crawl启动代码。不过，由于for的条件判断是前置判断，而go不支持do…while式的后置判断循环，所以for的终止条件只能移入for的内部，否则for i:=0; i\u003c0;将不会进入循环。\n抽象接口 对这道题来说，做完上面的部分，就已经完成了所有任务。不过从设计的角度，这个程序的输入和输出都混在一起（不会有真的只是打印就完事的抓取程序吧？）。能不能实现一个更好的接口呢？\n先来设想一下使用的情况。一个简洁好用的接口应该是什么样子的呢？下面的样子是不是足够简洁呢？\n1 2 3 4 5 6 7 8 9 func main() { for data := range CrawlWeb(\"http://golang.org/\", fetcher) { if data.err == nil { fmt.Println(\"found:\", data.url, data.body) } else { fmt.Println(\"not found:\", data.url) } } } 显然，为了实现并行，CrawlWeb应该返回一个chan，这个chan包含了抓取的相关信息：\n1 2 3 4 5 type FetchData struct { err os.Error url string body string } 对应修改Crawl的输出方式，使其不再直接Println结果，而是将结果打包，传入data chan作为输出：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func Crawl(url string, depth int, fetcher Fetcher, data chan\u003c- *FetchData, new_url chan\u003c- *UrlData, quit chan\u003c- int) { defer func() { quit \u003c- 1 }() if depth \u003c= 0 { return } body, urls, err := fetcher.Fetch(url) data \u003c- \u0026FetchData{err, url, body} for _, u := range urls { new_url \u003c- \u0026UrlData{u, depth - 1} } return } 由于在现在的main里，调用CrawlWeb后函数需要立刻返回，因此原先的for循环需要跑在一个单独的goroutine里，不能阻塞CrawlWeb的调用。为了清晰，将循环部分单独写成一个函数：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func CrawlLoop(url chan *UrlData, output chan\u003c- *FetchData, fetcher Fetcher) { defer func() { close(output) }() url_cache := make(map[string]bool) quit := make(chan int) for i := 0; ; { select { case \u003c-quit: i-- if i == 0 { return } case data := \u003c-url: if url_cache[data.url] { break } url_cache[data.url] = true go Crawl(data.url, data.depth, fetcher, output, url, quit) i++ } } } CrawLoop在退出时会close(output)，来结束main里的range循环。\n剩下的，就是如何用CrawlWeb来启动CrawlLoop，并将output chan作为返回值，返回给外面的range了：\n1 2 3 4 5 6 7 8 9 10 func CrawlWeb(start_url string, depth int, fetcher Fetcher) \u003c-chan *FetchData { output := make(chan *FetchData) url := make(chan *UrlData) go CrawlLoop(url, output, fetcher) url \u003c- \u0026UrlData{start_url, depth} return output } 对于CrawlLoop这个函数，作为goroutine启动后，可以将url chan视为输入，output chan视为输出，当给url chan传入数据时，启动CrawlLoop的真正执行，结果会在执行过程中从output中逐项输出。由于并发的因素，和传统函数调用不同，输出不是等待函数结束后一次性输出，而是在函数的执行过程中，output随时会输出结果，当函数执行完毕后关闭output。\n收工 最后，贴上修改后的所有代码。为了测试是否真正实现并行，我加入了一部分假数据。那么，如何测试是否真的实现了并发呢？有兴趣的可以自己动手实验一下。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 package main import ( \"os\" \"fmt\" ) type Fetcher interface { // Fetch returns the body of URL and // a slice of URLs found on that page. Fetch(url string) (body string, urls []string, err os.Error) } type UrlData struct { url string depth int } type FetchData struct { err os.Error url string body string } // Crawl uses fetcher to recursively crawl // pages starting with url, to a maximum of depth. func Crawl(url string, depth int, fetcher Fetcher, data chan\u003c- *FetchData, new_url chan\u003c- *UrlData, quit chan\u003c- int) { // TODO: Fetch URLs in parallel. // TODO: Don't fetch the same URL twice. // This implementation doesn't do either: defer func() { quit \u003c- 1 }() if depth \u003c= 0 { return } body, urls, err := fetcher.Fetch(url) data \u003c- \u0026FetchData{err, url, body} for _, u := range urls { new_url \u003c- \u0026UrlData{u, depth - 1} } return } func CrawlLoop(url chan *UrlData, output chan\u003c- *FetchData, fetcher Fetcher) { defer func() { close(output) }() url_cache := make(map[string]bool) quit := make(chan int) for i := 0; ; { select { case \u003c-quit: i-- if i == 0 { return } case data := \u003c-url: if url_cache[data.url] { break } url_cache[data.url] = true go Crawl(data.url, data.depth, fetcher, output, url, quit) i++ } } } func CrawlWeb(start_url string, depth int, fetcher Fetcher) \u003c-chan *FetchData { output := make(chan *FetchData) url := make(chan *UrlData) go CrawlLoop(url, output, fetcher) url \u003c- \u0026UrlData{start_url, depth} return output } func main() { for data := range CrawlWeb(\"http://golang.org/\", 4, fetcher) { if data.err == nil { fmt.Println(\"found:\", data.url, data.body) } else { fmt.Println(\"not found:\", data.url) } } } // fakeFetcher is Fetcher that returns canned results. type fakeFetcher map[string]*fakeResult type fakeResult struct { body string urls []string } func (f *fakeFetcher) Fetch(url string) (string, []string, os.Error) { if res, ok := (*f)[url]; ok { return res.body, res.urls, nil } return \"\", nil, fmt.Errorf(\"not found: %s\", url) } // fetcher is a populated fakeFetcher. var fetcher = \u0026fakeFetcher{ \"http://golang.org/\": \u0026fakeResult{ \"The Go Programming Language\", []string{ \"http://golang.org/pkg/\", \"http://golang.org/cmd/\", }, }, \"http://golang.org/pkg/\": \u0026fakeResult{ \"Packages\", []string{ \"http://golang.org/\", \"http://golang.org/cmd/\", \"http://golang.org/pkg/fmt/\", \"http://golang.org/pkg/os/\", }, }, \"http://golang.org/pkg/fmt/\": \u0026fakeResult{ \"Package fmt\", []string{ \"http://golang.org/\", \"http://golang.org/pkg/\", }, }, \"http://golang.org/pkg/os/\": \u0026fakeResult{ \"Package os\", []string{ \"http://golang.org/\", \"http://golang.org/pkg/\", }, }, \"http://golang.org/cmd/\": \u0026fakeResult{ \"Commands\", []string{ \"http://golang.org/cmd/6g\", \"http://golang.org/cmd/8g\", \"http://golang.org/cmd/\", \"http://golang.org/\", }, }, \"http://golang.org/cmd/6g\": \u0026fakeResult{ \"Command 6g\", []string{ \"http://golang.org/cmd/\", \"http://golang.org/\", }, }, } ","wordCount":"1523","inLanguage":"en","datePublished":"2012-02-04T20:00:00+08:00","dateModified":"2012-02-04T20:00:00+08:00","author":{"@type":"Person","name":"Googol Lee"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://air.googol.im/posts/gotour-exercise-web-crawl/"},"publisher":{"@type":"Organization","name":"Air On G","logo":{"@type":"ImageObject","url":"https://air.googol.im/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://air.googol.im/ accesskey=h title="Air On G (Alt + H)">Air On G</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://air.googol.im/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://air.googol.im/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://air.googol.im/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://air.googol.im/>Home</a>&nbsp;»&nbsp;<a href=https://air.googol.im/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">关于gotour最后一题的一些想法</h1><div class=post-meta><span title='2012-02-04 20:00:00 +0800 +0800'>2012-02-04</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;Googol Lee</div></header><div class=post-content><p>过年几天，把<a href=http://tour.golang.org/>A Tour of Go</a>看了一遍，算是复习了一遍go语言。其中最后一题<a href=http://tour.golang.org/#70>Exercise: Web Crawler</a>有些复杂，是串行程序转换到并行时常见的问题。这里记录一些当时思考的结果。</p><h2 id=原题>原题<a hidden class=anchor aria-hidden=true href=#原题>#</a></h2><p>将下面的网页抓取程序，由串行改为并行。修改Crawl函数，并发抓取url指向的页面，并且保证对同一页面只做一次抓去。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37>37</a>
</span><span class=lnt id=hl-0-38><a class=lnlinks href=#hl-0-38>38</a>
</span><span class=lnt id=hl-0-39><a class=lnlinks href=#hl-0-39>39</a>
</span><span class=lnt id=hl-0-40><a class=lnlinks href=#hl-0-40>40</a>
</span><span class=lnt id=hl-0-41><a class=lnlinks href=#hl-0-41>41</a>
</span><span class=lnt id=hl-0-42><a class=lnlinks href=#hl-0-42>42</a>
</span><span class=lnt id=hl-0-43><a class=lnlinks href=#hl-0-43>43</a>
</span><span class=lnt id=hl-0-44><a class=lnlinks href=#hl-0-44>44</a>
</span><span class=lnt id=hl-0-45><a class=lnlinks href=#hl-0-45>45</a>
</span><span class=lnt id=hl-0-46><a class=lnlinks href=#hl-0-46>46</a>
</span><span class=lnt id=hl-0-47><a class=lnlinks href=#hl-0-47>47</a>
</span><span class=lnt id=hl-0-48><a class=lnlinks href=#hl-0-48>48</a>
</span><span class=lnt id=hl-0-49><a class=lnlinks href=#hl-0-49>49</a>
</span><span class=lnt id=hl-0-50><a class=lnlinks href=#hl-0-50>50</a>
</span><span class=lnt id=hl-0-51><a class=lnlinks href=#hl-0-51>51</a>
</span><span class=lnt id=hl-0-52><a class=lnlinks href=#hl-0-52>52</a>
</span><span class=lnt id=hl-0-53><a class=lnlinks href=#hl-0-53>53</a>
</span><span class=lnt id=hl-0-54><a class=lnlinks href=#hl-0-54>54</a>
</span><span class=lnt id=hl-0-55><a class=lnlinks href=#hl-0-55>55</a>
</span><span class=lnt id=hl-0-56><a class=lnlinks href=#hl-0-56>56</a>
</span><span class=lnt id=hl-0-57><a class=lnlinks href=#hl-0-57>57</a>
</span><span class=lnt id=hl-0-58><a class=lnlinks href=#hl-0-58>58</a>
</span><span class=lnt id=hl-0-59><a class=lnlinks href=#hl-0-59>59</a>
</span><span class=lnt id=hl-0-60><a class=lnlinks href=#hl-0-60>60</a>
</span><span class=lnt id=hl-0-61><a class=lnlinks href=#hl-0-61>61</a>
</span><span class=lnt id=hl-0-62><a class=lnlinks href=#hl-0-62>62</a>
</span><span class=lnt id=hl-0-63><a class=lnlinks href=#hl-0-63>63</a>
</span><span class=lnt id=hl-0-64><a class=lnlinks href=#hl-0-64>64</a>
</span><span class=lnt id=hl-0-65><a class=lnlinks href=#hl-0-65>65</a>
</span><span class=lnt id=hl-0-66><a class=lnlinks href=#hl-0-66>66</a>
</span><span class=lnt id=hl-0-67><a class=lnlinks href=#hl-0-67>67</a>
</span><span class=lnt id=hl-0-68><a class=lnlinks href=#hl-0-68>68</a>
</span><span class=lnt id=hl-0-69><a class=lnlinks href=#hl-0-69>69</a>
</span><span class=lnt id=hl-0-70><a class=lnlinks href=#hl-0-70>70</a>
</span><span class=lnt id=hl-0-71><a class=lnlinks href=#hl-0-71>71</a>
</span><span class=lnt id=hl-0-72><a class=lnlinks href=#hl-0-72>72</a>
</span><span class=lnt id=hl-0-73><a class=lnlinks href=#hl-0-73>73</a>
</span><span class=lnt id=hl-0-74><a class=lnlinks href=#hl-0-74>74</a>
</span><span class=lnt id=hl-0-75><a class=lnlinks href=#hl-0-75>75</a>
</span><span class=lnt id=hl-0-76><a class=lnlinks href=#hl-0-76>76</a>
</span><span class=lnt id=hl-0-77><a class=lnlinks href=#hl-0-77>77</a>
</span><span class=lnt id=hl-0-78><a class=lnlinks href=#hl-0-78>78</a>
</span><span class=lnt id=hl-0-79><a class=lnlinks href=#hl-0-79>79</a>
</span><span class=lnt id=hl-0-80><a class=lnlinks href=#hl-0-80>80</a>
</span><span class=lnt id=hl-0-81><a class=lnlinks href=#hl-0-81>81</a>
</span><span class=lnt id=hl-0-82><a class=lnlinks href=#hl-0-82>82</a>
</span><span class=lnt id=hl-0-83><a class=lnlinks href=#hl-0-83>83</a>
</span><span class=lnt id=hl-0-84><a class=lnlinks href=#hl-0-84>84</a>
</span><span class=lnt id=hl-0-85><a class=lnlinks href=#hl-0-85>85</a>
</span><span class=lnt id=hl-0-86><a class=lnlinks href=#hl-0-86>86</a>
</span><span class=lnt id=hl-0-87><a class=lnlinks href=#hl-0-87>87</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Fetcher</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Fetch returns the body of URL and
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// a slice of URLs found on that page.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Fetch</span><span class=p>(</span><span class=nx>url</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>body</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>urls</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>err</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Crawl uses fetcher to recursively crawl
</span></span></span><span class=line><span class=cl><span class=c1>// pages starting with url, to a maximum of depth.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Crawl</span><span class=p>(</span><span class=nx>url</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>depth</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>fetcher</span> <span class=nx>Fetcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// TODO: Fetch URLs in parallel.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// TODO: Don&#39;t fetch the same URL twice.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This implementation doesn&#39;t do either:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>depth</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>body</span><span class=p>,</span> <span class=nx>urls</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>fetcher</span><span class=p>.</span><span class=nf>Fetch</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;found: %s %q\n&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>,</span> <span class=nx>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>Crawl</span><span class=p>(</span><span class=nx>u</span><span class=p>,</span> <span class=nx>depth</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>Crawl</span><span class=p>(</span><span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// fakeFetcher is Fetcher that returns canned results.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>fakeFetcher</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>fakeResult</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>fakeResult</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>body</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>urls</span>     <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>fakeFetcher</span><span class=p>)</span> <span class=nf>Fetch</span><span class=p>(</span><span class=nx>url</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=p>(</span><span class=o>*</span><span class=nx>f</span><span class=p>)[</span><span class=nx>url</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>,</span> <span class=nx>res</span><span class=p>.</span><span class=nx>urls</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;not found: %s&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// fetcher is a populated fakeFetcher.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>fetcher</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>fakeFetcher</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;http://golang.org/&#34;</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>fakeResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;The Go Programming Language&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/pkg/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/cmd/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;http://golang.org/pkg/&#34;</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>fakeResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;Packages&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/cmd/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/pkg/fmt/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/pkg/os/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;http://golang.org/pkg/fmt/&#34;</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>fakeResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;Package fmt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/pkg/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;http://golang.org/pkg/os/&#34;</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>fakeResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;Package os&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/pkg/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>程序有些长有些长，因为还包括一部分假数据。程序入口在<code>func main</code>里，提供<code>"http://golang.org/"</code>作为起始页面，抓取深度是4，使用fetcher作为抓取算法。</p><h2 id=第一次并行化>第一次并行化<a hidden class=anchor aria-hidden=true href=#第一次并行化>#</a></h2><p>最初的想法是让每个Crawl单独跑一个goroutine，当Crawl里抓到新的url时，就启动一个新的goroutine。这个改动很简单，只需要修改Crawl函数就行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span><span class=lnt id=hl-1-15><a class=lnlinks href=#hl-1-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Crawl</span><span class=p>(</span><span class=nx>url</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>depth</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>fetcher</span> <span class=nx>Fetcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>depth</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>body</span><span class=p>,</span> <span class=nx>urls</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>fetcher</span><span class=p>.</span><span class=nf>Fetch</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;found: %s %q\n&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>,</span> <span class=nx>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=nf>Crawl</span><span class=p>(</span><span class=nx>u</span><span class=p>,</span> <span class=nx>depth</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>但实际结果却是只打印最初的一条“http://golang.org/”就结束了。因为go的程序在终止时，并不等待其余goroutine的结束，Crawl内用<code>go Crawl(...)</code>的方式递归调用后，main并不等待新建的goroutine的结束，就结束了整个程序，因此其余的url还没有抓取，就结束了。</p><h2 id=监视goroutine的启动和退出>监视goroutine的启动和退出<a hidden class=anchor aria-hidden=true href=#监视goroutine的启动和退出>#</a></h2><p>因此，程序需要有办法监控总共启动了多少个goroutine，而且还要能知道，是否所有goroutine都已经运行完毕退出了。传统的并发程序，是通过thread id或者thread handler，配合类似join的api来完成的。但是go没有任何对goroutine的控制方法，要想知道goroutine的状态，只能在其内部，通过chan将状态发送给接收者。同时，为了方便对goroutine进行计数，最好将所有goroutine的启动放在一个函数内，这就需要Crawl将新抓到的url发到一个特殊的控制函数，这个控制函数在接收到新的url后，启动新的Crawl进行抓取。程序修改如下：</p><p>新建一个UrlData结构，用来传递新抓到的url，以及这个url对应的抓取深度depth：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>UrlData</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>url</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>depth</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>修改Crawl函数，加入两个chan，quit对应函数退出的信号，urldata对应抓取到新的url时的新数据传输通道。注意defer是如何间接明了的完成发送quit信号的功能的（对比C++的析构函数概念，defer要清晰明快的多，而且有closure的加持，能做的事情也比析构多）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a class=lnlinks href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a class=lnlinks href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a class=lnlinks href=#hl-3-13>13</a>
</span><span class=lnt id=hl-3-14><a class=lnlinks href=#hl-3-14>14</a>
</span><span class=lnt id=hl-3-15><a class=lnlinks href=#hl-3-15>15</a>
</span><span class=lnt id=hl-3-16><a class=lnlinks href=#hl-3-16>16</a>
</span><span class=lnt id=hl-3-17><a class=lnlinks href=#hl-3-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Crawl</span><span class=p>(</span><span class=nx>url</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>depth</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>fetcher</span> <span class=nx>Fetcher</span><span class=p>,</span> <span class=nx>urldata</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=o>*</span><span class=nx>UrlData</span><span class=p>,</span> <span class=nx>quit</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=nx>quit</span> <span class=o>&lt;-</span> <span class=mi>1</span> <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>depth</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>body</span><span class=p>,</span> <span class=nx>urls</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>fetcher</span><span class=p>.</span><span class=nf>Fetch</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;found: %s %q\n&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>,</span> <span class=nx>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>urldata</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>UrlData</span><span class=p>{</span><span class=nx>u</span><span class=p>,</span> <span class=nx>depth</span><span class=o>-</span><span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>修改main函数，加入对goroutine的控制：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>urldata</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>UrlData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>quit</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nf>Crawl</span><span class=p>(</span><span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>,</span> <span class=nx>urldata</span><span class=p>,</span> <span class=nx>quit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=o>:=</span><span class=mi>1</span><span class=p>;</span> <span class=nx>i</span><span class=p>&gt;</span><span class=mi>0</span><span class=p>;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>quit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>i</span><span class=o>--</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>url</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>urldata</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>go</span> <span class=nf>Crawl</span><span class=p>(</span><span class=nx>url</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=nx>url</span><span class=p>.</span><span class=nx>depth</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>,</span> <span class=nx>urldata</span><span class=p>,</span> <span class=nx>quit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>i</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这样，整个程序在流程上就没有问题了。</p><h2 id=加入cache对同一网址只crawl一遍>加入cache，对同一网址只Crawl一遍<a hidden class=anchor aria-hidden=true href=#加入cache对同一网址只crawl一遍>#</a></h2><p>因为所有Crawl都是由main函数控制的，因此这个改动只在main里修改即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a class=lnlinks href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a class=lnlinks href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a class=lnlinks href=#hl-5-16>16</a>
</span><span class=lnt id=hl-5-17><a class=lnlinks href=#hl-5-17>17</a>
</span><span class=lnt id=hl-5-18><a class=lnlinks href=#hl-5-18>18</a>
</span><span class=lnt id=hl-5-19><a class=lnlinks href=#hl-5-19>19</a>
</span><span class=lnt id=hl-5-20><a class=lnlinks href=#hl-5-20>20</a>
</span><span class=lnt id=hl-5-21><a class=lnlinks href=#hl-5-21>21</a>
</span><span class=lnt id=hl-5-22><a class=lnlinks href=#hl-5-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>urldata</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>UrlData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>quit</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>url_cache</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>url_cache</span><span class=p>[</span><span class=s>&#34;http://golang.org/&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nf>Crawl</span><span class=p>(</span><span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>,</span> <span class=nx>urldata</span><span class=p>,</span> <span class=nx>quit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=o>:=</span><span class=mi>1</span><span class=p>;</span> <span class=nx>i</span><span class=p>&gt;</span><span class=mi>0</span><span class=p>;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>quit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>i</span><span class=o>--</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>url</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>urldata</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>url_cache</span><span class=p>[</span><span class=nx>url</span><span class=p>.</span><span class=nx>url</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>url_cache</span><span class=p>[</span><span class=nx>url</span><span class=p>.</span><span class=nx>url</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=k>go</span> <span class=nf>Crawl</span><span class=p>(</span><span class=nx>url</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=nx>url</span><span class=p>.</span><span class=nx>depth</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>,</span> <span class=nx>urldata</span><span class=p>,</span> <span class=nx>quit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>i</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>url_cache是一个key为string，value为bool的map，在有新的url传入时，先以url为key，检查其value是否为true。如果为true说明已经Crawl过，不再处理，如果为false，先将value设置为true，然后启动Crawl对这个url进行抓取。</p><h2 id=重构dry>重构，DRY<a hidden class=anchor aria-hidden=true href=#重构dry>#</a></h2><p>你注意到了么？main函数里有两个地方对url_cache进行操作并启动Crawl。一个是在for循环外面，设置启动url，另一个是在for循环里面，处理新的url。这两个地方所做的事情，本质上都是对一个新url的处理，但为什么要写两遍呢？现在就来试试能不能将其合并：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a class=lnlinks href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a class=lnlinks href=#hl-6-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>urldata</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>UrlData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>quit</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>url_cache</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=nx>urldata</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>UrlData</span><span class=p>{</span><span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>}</span> <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Loop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>quit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>i</span><span class=o>--</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>i</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span> <span class=nx>Loop</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>url</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>urldata</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>url_cache</span><span class=p>[</span><span class=nx>url</span><span class=p>.</span><span class=nx>url</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>url_cache</span><span class=p>[</span><span class=nx>url</span><span class=p>.</span><span class=nx>url</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=k>go</span> <span class=nf>Crawl</span><span class=p>(</span><span class=nx>url</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=nx>url</span><span class=p>.</span><span class=nx>depth</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>,</span> <span class=nx>urldata</span><span class=p>,</span> <span class=nx>quit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>i</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>利用已有的urldata chan，将初始url和depth作为参数传入，就可以去掉for外面的Crawl启动代码。不过，由于for的条件判断是前置判断，而go不支持do&mldr;while式的后置判断循环，所以for的终止条件只能移入for的内部，否则<code>for i:=0; i&lt;0;</code>将不会进入循环。</p><h2 id=抽象接口>抽象接口<a hidden class=anchor aria-hidden=true href=#抽象接口>#</a></h2><p>对这道题来说，做完上面的部分，就已经完成了所有任务。不过从设计的角度，这个程序的输入和输出都混在一起（不会有真的只是打印就完事的抓取程序吧？）。能不能实现一个更好的接口呢？</p><p>先来设想一下使用的情况。一个简洁好用的接口应该是什么样子的呢？下面的样子是不是足够简洁呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4>4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5>5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6>6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7>7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8>8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>data</span> <span class=o>:=</span> <span class=k>range</span> <span class=nf>CrawlWeb</span><span class=p>(</span><span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>data</span><span class=p>.</span><span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;found:&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;not found:&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>显然，为了实现并行，CrawlWeb应该返回一个chan，这个chan包含了抓取的相关信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2>2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3>3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4>4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>FetchData</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Error</span>
</span></span><span class=line><span class=cl>	<span class=nx>url</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>body</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对应修改Crawl的输出方式，使其不再直接Println结果，而是将结果打包，传入data chan作为输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Crawl</span><span class=p>(</span><span class=nx>url</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>depth</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>fetcher</span> <span class=nx>Fetcher</span><span class=p>,</span> <span class=nx>data</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=o>*</span><span class=nx>FetchData</span><span class=p>,</span> <span class=nx>new_url</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=o>*</span><span class=nx>UrlData</span><span class=p>,</span> <span class=nx>quit</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=nx>quit</span> <span class=o>&lt;-</span> <span class=mi>1</span> <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>depth</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>body</span><span class=p>,</span> <span class=nx>urls</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>fetcher</span><span class=p>.</span><span class=nf>Fetch</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>data</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>FetchData</span><span class=p>{</span><span class=nx>err</span><span class=p>,</span> <span class=nx>url</span><span class=p>,</span> <span class=nx>body</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>new_url</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>UrlData</span><span class=p>{</span><span class=nx>u</span><span class=p>,</span> <span class=nx>depth</span> <span class=o>-</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>由于在现在的main里，调用CrawlWeb后函数需要立刻返回，因此原先的for循环需要跑在一个单独的goroutine里，不能阻塞CrawlWeb的调用。为了清晰，将循环部分单独写成一个函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10>10</a>
</span><span class=lnt id=hl-10-11><a class=lnlinks href=#hl-10-11>11</a>
</span><span class=lnt id=hl-10-12><a class=lnlinks href=#hl-10-12>12</a>
</span><span class=lnt id=hl-10-13><a class=lnlinks href=#hl-10-13>13</a>
</span><span class=lnt id=hl-10-14><a class=lnlinks href=#hl-10-14>14</a>
</span><span class=lnt id=hl-10-15><a class=lnlinks href=#hl-10-15>15</a>
</span><span class=lnt id=hl-10-16><a class=lnlinks href=#hl-10-16>16</a>
</span><span class=lnt id=hl-10-17><a class=lnlinks href=#hl-10-17>17</a>
</span><span class=lnt id=hl-10-18><a class=lnlinks href=#hl-10-18>18</a>
</span><span class=lnt id=hl-10-19><a class=lnlinks href=#hl-10-19>19</a>
</span><span class=lnt id=hl-10-20><a class=lnlinks href=#hl-10-20>20</a>
</span><span class=lnt id=hl-10-21><a class=lnlinks href=#hl-10-21>21</a>
</span><span class=lnt id=hl-10-22><a class=lnlinks href=#hl-10-22>22</a>
</span><span class=lnt id=hl-10-23><a class=lnlinks href=#hl-10-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>CrawlLoop</span><span class=p>(</span><span class=nx>url</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>UrlData</span><span class=p>,</span> <span class=nx>output</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=o>*</span><span class=nx>FetchData</span><span class=p>,</span> <span class=nx>fetcher</span> <span class=nx>Fetcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=nb>close</span><span class=p>(</span><span class=nx>output</span><span class=p>)</span> <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>url_cache</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>quit</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>quit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>i</span><span class=o>--</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>i</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>data</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>url</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>url_cache</span><span class=p>[</span><span class=nx>data</span><span class=p>.</span><span class=nx>url</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>url_cache</span><span class=p>[</span><span class=nx>data</span><span class=p>.</span><span class=nx>url</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=k>go</span> <span class=nf>Crawl</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>depth</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>,</span> <span class=nx>output</span><span class=p>,</span> <span class=nx>url</span><span class=p>,</span> <span class=nx>quit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>i</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>CrawLoop在退出时会close(output)，来结束main里的range循环。</p><p>剩下的，就是如何用CrawlWeb来启动CrawlLoop，并将output chan作为返回值，返回给外面的range了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>CrawlWeb</span><span class=p>(</span><span class=nx>start_url</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>depth</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>fetcher</span> <span class=nx>Fetcher</span><span class=p>)</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>FetchData</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>output</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>FetchData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>url</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>UrlData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nf>CrawlLoop</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>output</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>url</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>UrlData</span><span class=p>{</span><span class=nx>start_url</span><span class=p>,</span> <span class=nx>depth</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>output</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于CrawlLoop这个函数，作为goroutine启动后，可以将url chan视为输入，output chan视为输出，当给url chan传入数据时，启动CrawlLoop的真正执行，结果会在执行过程中从output中逐项输出。由于并发的因素，和传统函数调用不同，输出不是等待函数结束后一次性输出，而是在函数的执行过程中，output随时会输出结果，当函数执行完毕后关闭output。</p><h2 id=收工>收工<a hidden class=anchor aria-hidden=true href=#收工>#</a></h2><p>最后，贴上修改后的所有代码。为了测试是否真正实现并行，我加入了一部分假数据。那么，如何测试是否真的实现了并发呢？有兴趣的可以自己动手实验一下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>  1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2>  2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3>  3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4>  4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5>  5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6>  6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7>  7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8>  8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9>  9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10> 10</a>
</span><span class=lnt id=hl-12-11><a class=lnlinks href=#hl-12-11> 11</a>
</span><span class=lnt id=hl-12-12><a class=lnlinks href=#hl-12-12> 12</a>
</span><span class=lnt id=hl-12-13><a class=lnlinks href=#hl-12-13> 13</a>
</span><span class=lnt id=hl-12-14><a class=lnlinks href=#hl-12-14> 14</a>
</span><span class=lnt id=hl-12-15><a class=lnlinks href=#hl-12-15> 15</a>
</span><span class=lnt id=hl-12-16><a class=lnlinks href=#hl-12-16> 16</a>
</span><span class=lnt id=hl-12-17><a class=lnlinks href=#hl-12-17> 17</a>
</span><span class=lnt id=hl-12-18><a class=lnlinks href=#hl-12-18> 18</a>
</span><span class=lnt id=hl-12-19><a class=lnlinks href=#hl-12-19> 19</a>
</span><span class=lnt id=hl-12-20><a class=lnlinks href=#hl-12-20> 20</a>
</span><span class=lnt id=hl-12-21><a class=lnlinks href=#hl-12-21> 21</a>
</span><span class=lnt id=hl-12-22><a class=lnlinks href=#hl-12-22> 22</a>
</span><span class=lnt id=hl-12-23><a class=lnlinks href=#hl-12-23> 23</a>
</span><span class=lnt id=hl-12-24><a class=lnlinks href=#hl-12-24> 24</a>
</span><span class=lnt id=hl-12-25><a class=lnlinks href=#hl-12-25> 25</a>
</span><span class=lnt id=hl-12-26><a class=lnlinks href=#hl-12-26> 26</a>
</span><span class=lnt id=hl-12-27><a class=lnlinks href=#hl-12-27> 27</a>
</span><span class=lnt id=hl-12-28><a class=lnlinks href=#hl-12-28> 28</a>
</span><span class=lnt id=hl-12-29><a class=lnlinks href=#hl-12-29> 29</a>
</span><span class=lnt id=hl-12-30><a class=lnlinks href=#hl-12-30> 30</a>
</span><span class=lnt id=hl-12-31><a class=lnlinks href=#hl-12-31> 31</a>
</span><span class=lnt id=hl-12-32><a class=lnlinks href=#hl-12-32> 32</a>
</span><span class=lnt id=hl-12-33><a class=lnlinks href=#hl-12-33> 33</a>
</span><span class=lnt id=hl-12-34><a class=lnlinks href=#hl-12-34> 34</a>
</span><span class=lnt id=hl-12-35><a class=lnlinks href=#hl-12-35> 35</a>
</span><span class=lnt id=hl-12-36><a class=lnlinks href=#hl-12-36> 36</a>
</span><span class=lnt id=hl-12-37><a class=lnlinks href=#hl-12-37> 37</a>
</span><span class=lnt id=hl-12-38><a class=lnlinks href=#hl-12-38> 38</a>
</span><span class=lnt id=hl-12-39><a class=lnlinks href=#hl-12-39> 39</a>
</span><span class=lnt id=hl-12-40><a class=lnlinks href=#hl-12-40> 40</a>
</span><span class=lnt id=hl-12-41><a class=lnlinks href=#hl-12-41> 41</a>
</span><span class=lnt id=hl-12-42><a class=lnlinks href=#hl-12-42> 42</a>
</span><span class=lnt id=hl-12-43><a class=lnlinks href=#hl-12-43> 43</a>
</span><span class=lnt id=hl-12-44><a class=lnlinks href=#hl-12-44> 44</a>
</span><span class=lnt id=hl-12-45><a class=lnlinks href=#hl-12-45> 45</a>
</span><span class=lnt id=hl-12-46><a class=lnlinks href=#hl-12-46> 46</a>
</span><span class=lnt id=hl-12-47><a class=lnlinks href=#hl-12-47> 47</a>
</span><span class=lnt id=hl-12-48><a class=lnlinks href=#hl-12-48> 48</a>
</span><span class=lnt id=hl-12-49><a class=lnlinks href=#hl-12-49> 49</a>
</span><span class=lnt id=hl-12-50><a class=lnlinks href=#hl-12-50> 50</a>
</span><span class=lnt id=hl-12-51><a class=lnlinks href=#hl-12-51> 51</a>
</span><span class=lnt id=hl-12-52><a class=lnlinks href=#hl-12-52> 52</a>
</span><span class=lnt id=hl-12-53><a class=lnlinks href=#hl-12-53> 53</a>
</span><span class=lnt id=hl-12-54><a class=lnlinks href=#hl-12-54> 54</a>
</span><span class=lnt id=hl-12-55><a class=lnlinks href=#hl-12-55> 55</a>
</span><span class=lnt id=hl-12-56><a class=lnlinks href=#hl-12-56> 56</a>
</span><span class=lnt id=hl-12-57><a class=lnlinks href=#hl-12-57> 57</a>
</span><span class=lnt id=hl-12-58><a class=lnlinks href=#hl-12-58> 58</a>
</span><span class=lnt id=hl-12-59><a class=lnlinks href=#hl-12-59> 59</a>
</span><span class=lnt id=hl-12-60><a class=lnlinks href=#hl-12-60> 60</a>
</span><span class=lnt id=hl-12-61><a class=lnlinks href=#hl-12-61> 61</a>
</span><span class=lnt id=hl-12-62><a class=lnlinks href=#hl-12-62> 62</a>
</span><span class=lnt id=hl-12-63><a class=lnlinks href=#hl-12-63> 63</a>
</span><span class=lnt id=hl-12-64><a class=lnlinks href=#hl-12-64> 64</a>
</span><span class=lnt id=hl-12-65><a class=lnlinks href=#hl-12-65> 65</a>
</span><span class=lnt id=hl-12-66><a class=lnlinks href=#hl-12-66> 66</a>
</span><span class=lnt id=hl-12-67><a class=lnlinks href=#hl-12-67> 67</a>
</span><span class=lnt id=hl-12-68><a class=lnlinks href=#hl-12-68> 68</a>
</span><span class=lnt id=hl-12-69><a class=lnlinks href=#hl-12-69> 69</a>
</span><span class=lnt id=hl-12-70><a class=lnlinks href=#hl-12-70> 70</a>
</span><span class=lnt id=hl-12-71><a class=lnlinks href=#hl-12-71> 71</a>
</span><span class=lnt id=hl-12-72><a class=lnlinks href=#hl-12-72> 72</a>
</span><span class=lnt id=hl-12-73><a class=lnlinks href=#hl-12-73> 73</a>
</span><span class=lnt id=hl-12-74><a class=lnlinks href=#hl-12-74> 74</a>
</span><span class=lnt id=hl-12-75><a class=lnlinks href=#hl-12-75> 75</a>
</span><span class=lnt id=hl-12-76><a class=lnlinks href=#hl-12-76> 76</a>
</span><span class=lnt id=hl-12-77><a class=lnlinks href=#hl-12-77> 77</a>
</span><span class=lnt id=hl-12-78><a class=lnlinks href=#hl-12-78> 78</a>
</span><span class=lnt id=hl-12-79><a class=lnlinks href=#hl-12-79> 79</a>
</span><span class=lnt id=hl-12-80><a class=lnlinks href=#hl-12-80> 80</a>
</span><span class=lnt id=hl-12-81><a class=lnlinks href=#hl-12-81> 81</a>
</span><span class=lnt id=hl-12-82><a class=lnlinks href=#hl-12-82> 82</a>
</span><span class=lnt id=hl-12-83><a class=lnlinks href=#hl-12-83> 83</a>
</span><span class=lnt id=hl-12-84><a class=lnlinks href=#hl-12-84> 84</a>
</span><span class=lnt id=hl-12-85><a class=lnlinks href=#hl-12-85> 85</a>
</span><span class=lnt id=hl-12-86><a class=lnlinks href=#hl-12-86> 86</a>
</span><span class=lnt id=hl-12-87><a class=lnlinks href=#hl-12-87> 87</a>
</span><span class=lnt id=hl-12-88><a class=lnlinks href=#hl-12-88> 88</a>
</span><span class=lnt id=hl-12-89><a class=lnlinks href=#hl-12-89> 89</a>
</span><span class=lnt id=hl-12-90><a class=lnlinks href=#hl-12-90> 90</a>
</span><span class=lnt id=hl-12-91><a class=lnlinks href=#hl-12-91> 91</a>
</span><span class=lnt id=hl-12-92><a class=lnlinks href=#hl-12-92> 92</a>
</span><span class=lnt id=hl-12-93><a class=lnlinks href=#hl-12-93> 93</a>
</span><span class=lnt id=hl-12-94><a class=lnlinks href=#hl-12-94> 94</a>
</span><span class=lnt id=hl-12-95><a class=lnlinks href=#hl-12-95> 95</a>
</span><span class=lnt id=hl-12-96><a class=lnlinks href=#hl-12-96> 96</a>
</span><span class=lnt id=hl-12-97><a class=lnlinks href=#hl-12-97> 97</a>
</span><span class=lnt id=hl-12-98><a class=lnlinks href=#hl-12-98> 98</a>
</span><span class=lnt id=hl-12-99><a class=lnlinks href=#hl-12-99> 99</a>
</span><span class=lnt id=hl-12-100><a class=lnlinks href=#hl-12-100>100</a>
</span><span class=lnt id=hl-12-101><a class=lnlinks href=#hl-12-101>101</a>
</span><span class=lnt id=hl-12-102><a class=lnlinks href=#hl-12-102>102</a>
</span><span class=lnt id=hl-12-103><a class=lnlinks href=#hl-12-103>103</a>
</span><span class=lnt id=hl-12-104><a class=lnlinks href=#hl-12-104>104</a>
</span><span class=lnt id=hl-12-105><a class=lnlinks href=#hl-12-105>105</a>
</span><span class=lnt id=hl-12-106><a class=lnlinks href=#hl-12-106>106</a>
</span><span class=lnt id=hl-12-107><a class=lnlinks href=#hl-12-107>107</a>
</span><span class=lnt id=hl-12-108><a class=lnlinks href=#hl-12-108>108</a>
</span><span class=lnt id=hl-12-109><a class=lnlinks href=#hl-12-109>109</a>
</span><span class=lnt id=hl-12-110><a class=lnlinks href=#hl-12-110>110</a>
</span><span class=lnt id=hl-12-111><a class=lnlinks href=#hl-12-111>111</a>
</span><span class=lnt id=hl-12-112><a class=lnlinks href=#hl-12-112>112</a>
</span><span class=lnt id=hl-12-113><a class=lnlinks href=#hl-12-113>113</a>
</span><span class=lnt id=hl-12-114><a class=lnlinks href=#hl-12-114>114</a>
</span><span class=lnt id=hl-12-115><a class=lnlinks href=#hl-12-115>115</a>
</span><span class=lnt id=hl-12-116><a class=lnlinks href=#hl-12-116>116</a>
</span><span class=lnt id=hl-12-117><a class=lnlinks href=#hl-12-117>117</a>
</span><span class=lnt id=hl-12-118><a class=lnlinks href=#hl-12-118>118</a>
</span><span class=lnt id=hl-12-119><a class=lnlinks href=#hl-12-119>119</a>
</span><span class=lnt id=hl-12-120><a class=lnlinks href=#hl-12-120>120</a>
</span><span class=lnt id=hl-12-121><a class=lnlinks href=#hl-12-121>121</a>
</span><span class=lnt id=hl-12-122><a class=lnlinks href=#hl-12-122>122</a>
</span><span class=lnt id=hl-12-123><a class=lnlinks href=#hl-12-123>123</a>
</span><span class=lnt id=hl-12-124><a class=lnlinks href=#hl-12-124>124</a>
</span><span class=lnt id=hl-12-125><a class=lnlinks href=#hl-12-125>125</a>
</span><span class=lnt id=hl-12-126><a class=lnlinks href=#hl-12-126>126</a>
</span><span class=lnt id=hl-12-127><a class=lnlinks href=#hl-12-127>127</a>
</span><span class=lnt id=hl-12-128><a class=lnlinks href=#hl-12-128>128</a>
</span><span class=lnt id=hl-12-129><a class=lnlinks href=#hl-12-129>129</a>
</span><span class=lnt id=hl-12-130><a class=lnlinks href=#hl-12-130>130</a>
</span><span class=lnt id=hl-12-131><a class=lnlinks href=#hl-12-131>131</a>
</span><span class=lnt id=hl-12-132><a class=lnlinks href=#hl-12-132>132</a>
</span><span class=lnt id=hl-12-133><a class=lnlinks href=#hl-12-133>133</a>
</span><span class=lnt id=hl-12-134><a class=lnlinks href=#hl-12-134>134</a>
</span><span class=lnt id=hl-12-135><a class=lnlinks href=#hl-12-135>135</a>
</span><span class=lnt id=hl-12-136><a class=lnlinks href=#hl-12-136>136</a>
</span><span class=lnt id=hl-12-137><a class=lnlinks href=#hl-12-137>137</a>
</span><span class=lnt id=hl-12-138><a class=lnlinks href=#hl-12-138>138</a>
</span><span class=lnt id=hl-12-139><a class=lnlinks href=#hl-12-139>139</a>
</span><span class=lnt id=hl-12-140><a class=lnlinks href=#hl-12-140>140</a>
</span><span class=lnt id=hl-12-141><a class=lnlinks href=#hl-12-141>141</a>
</span><span class=lnt id=hl-12-142><a class=lnlinks href=#hl-12-142>142</a>
</span><span class=lnt id=hl-12-143><a class=lnlinks href=#hl-12-143>143</a>
</span><span class=lnt id=hl-12-144><a class=lnlinks href=#hl-12-144>144</a>
</span><span class=lnt id=hl-12-145><a class=lnlinks href=#hl-12-145>145</a>
</span><span class=lnt id=hl-12-146><a class=lnlinks href=#hl-12-146>146</a>
</span><span class=lnt id=hl-12-147><a class=lnlinks href=#hl-12-147>147</a>
</span><span class=lnt id=hl-12-148><a class=lnlinks href=#hl-12-148>148</a>
</span><span class=lnt id=hl-12-149><a class=lnlinks href=#hl-12-149>149</a>
</span><span class=lnt id=hl-12-150><a class=lnlinks href=#hl-12-150>150</a>
</span><span class=lnt id=hl-12-151><a class=lnlinks href=#hl-12-151>151</a>
</span><span class=lnt id=hl-12-152><a class=lnlinks href=#hl-12-152>152</a>
</span><span class=lnt id=hl-12-153><a class=lnlinks href=#hl-12-153>153</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Fetcher</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Fetch returns the body of URL and
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// a slice of URLs found on that page.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Fetch</span><span class=p>(</span><span class=nx>url</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>body</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>urls</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>err</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>UrlData</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>url</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>depth</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>FetchData</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Error</span>
</span></span><span class=line><span class=cl>	<span class=nx>url</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>body</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Crawl uses fetcher to recursively crawl
</span></span></span><span class=line><span class=cl><span class=c1>// pages starting with url, to a maximum of depth.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Crawl</span><span class=p>(</span><span class=nx>url</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>depth</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>fetcher</span> <span class=nx>Fetcher</span><span class=p>,</span> <span class=nx>data</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=o>*</span><span class=nx>FetchData</span><span class=p>,</span> <span class=nx>new_url</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=o>*</span><span class=nx>UrlData</span><span class=p>,</span> <span class=nx>quit</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// TODO: Fetch URLs in parallel.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// TODO: Don&#39;t fetch the same URL twice.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This implementation doesn&#39;t do either:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=nx>quit</span> <span class=o>&lt;-</span> <span class=mi>1</span> <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>depth</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>body</span><span class=p>,</span> <span class=nx>urls</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>fetcher</span><span class=p>.</span><span class=nf>Fetch</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>data</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>FetchData</span><span class=p>{</span><span class=nx>err</span><span class=p>,</span> <span class=nx>url</span><span class=p>,</span> <span class=nx>body</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>u</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>new_url</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>UrlData</span><span class=p>{</span><span class=nx>u</span><span class=p>,</span> <span class=nx>depth</span> <span class=o>-</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>CrawlLoop</span><span class=p>(</span><span class=nx>url</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>UrlData</span><span class=p>,</span> <span class=nx>output</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=o>*</span><span class=nx>FetchData</span><span class=p>,</span> <span class=nx>fetcher</span> <span class=nx>Fetcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=nb>close</span><span class=p>(</span><span class=nx>output</span><span class=p>)</span> <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>url_cache</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>quit</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>quit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>i</span><span class=o>--</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>i</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>data</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>url</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>url_cache</span><span class=p>[</span><span class=nx>data</span><span class=p>.</span><span class=nx>url</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>url_cache</span><span class=p>[</span><span class=nx>data</span><span class=p>.</span><span class=nx>url</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=k>go</span> <span class=nf>Crawl</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>depth</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>,</span> <span class=nx>output</span><span class=p>,</span> <span class=nx>url</span><span class=p>,</span> <span class=nx>quit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>i</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>CrawlWeb</span><span class=p>(</span><span class=nx>start_url</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>depth</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>fetcher</span> <span class=nx>Fetcher</span><span class=p>)</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>FetchData</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>output</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>FetchData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>url</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>UrlData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nf>CrawlLoop</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>output</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>url</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>UrlData</span><span class=p>{</span><span class=nx>start_url</span><span class=p>,</span> <span class=nx>depth</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>output</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>data</span> <span class=o>:=</span> <span class=k>range</span> <span class=nf>CrawlWeb</span><span class=p>(</span><span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>fetcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>data</span><span class=p>.</span><span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;found:&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;not found:&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// fakeFetcher is Fetcher that returns canned results.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>fakeFetcher</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>fakeResult</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>fakeResult</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>body</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>urls</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>fakeFetcher</span><span class=p>)</span> <span class=nf>Fetch</span><span class=p>(</span><span class=nx>url</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=p>(</span><span class=o>*</span><span class=nx>f</span><span class=p>)[</span><span class=nx>url</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>,</span> <span class=nx>res</span><span class=p>.</span><span class=nx>urls</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;not found: %s&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// fetcher is a populated fakeFetcher.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>fetcher</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>fakeFetcher</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;http://golang.org/&#34;</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>fakeResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;The Go Programming Language&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/pkg/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/cmd/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;http://golang.org/pkg/&#34;</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>fakeResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;Packages&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/cmd/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/pkg/fmt/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/pkg/os/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;http://golang.org/pkg/fmt/&#34;</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>fakeResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;Package fmt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/pkg/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;http://golang.org/pkg/os/&#34;</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>fakeResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;Package os&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/pkg/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;http://golang.org/cmd/&#34;</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>fakeResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;Commands&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/cmd/6g&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/cmd/8g&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/cmd/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;http://golang.org/cmd/6g&#34;</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>fakeResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;Command 6g&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/cmd/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;http://golang.org/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://air.googol.im/tags/golang/>Golang</a></li></ul><nav class=paginav><a class=prev href=https://air.googol.im/posts/why-i-like-go/><span class=title>« Prev</span><br><span>我为什么喜欢Go</span>
</a><a class=next href=https://air.googol.im/posts/how-to-save-password/><span class=title>Next »</span><br><span>到底应该怎么存密码</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 关于gotour最后一题的一些想法 on x" href="https://x.com/intent/tweet/?text=%e5%85%b3%e4%ba%8egotour%e6%9c%80%e5%90%8e%e4%b8%80%e9%a2%98%e7%9a%84%e4%b8%80%e4%ba%9b%e6%83%b3%e6%b3%95&amp;url=https%3a%2f%2fair.googol.im%2fposts%2fgotour-exercise-web-crawl%2f&amp;hashtags=golang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 关于gotour最后一题的一些想法 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fair.googol.im%2fposts%2fgotour-exercise-web-crawl%2f&amp;title=%e5%85%b3%e4%ba%8egotour%e6%9c%80%e5%90%8e%e4%b8%80%e9%a2%98%e7%9a%84%e4%b8%80%e4%ba%9b%e6%83%b3%e6%b3%95&amp;summary=%e5%85%b3%e4%ba%8egotour%e6%9c%80%e5%90%8e%e4%b8%80%e9%a2%98%e7%9a%84%e4%b8%80%e4%ba%9b%e6%83%b3%e6%b3%95&amp;source=https%3a%2f%2fair.googol.im%2fposts%2fgotour-exercise-web-crawl%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 关于gotour最后一题的一些想法 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fair.googol.im%2fposts%2fgotour-exercise-web-crawl%2f&title=%e5%85%b3%e4%ba%8egotour%e6%9c%80%e5%90%8e%e4%b8%80%e9%a2%98%e7%9a%84%e4%b8%80%e4%ba%9b%e6%83%b3%e6%b3%95"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 关于gotour最后一题的一些想法 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fair.googol.im%2fposts%2fgotour-exercise-web-crawl%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 关于gotour最后一题的一些想法 on whatsapp" href="https://api.whatsapp.com/send?text=%e5%85%b3%e4%ba%8egotour%e6%9c%80%e5%90%8e%e4%b8%80%e9%a2%98%e7%9a%84%e4%b8%80%e4%ba%9b%e6%83%b3%e6%b3%95%20-%20https%3a%2f%2fair.googol.im%2fposts%2fgotour-exercise-web-crawl%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 关于gotour最后一题的一些想法 on telegram" href="https://telegram.me/share/url?text=%e5%85%b3%e4%ba%8egotour%e6%9c%80%e5%90%8e%e4%b8%80%e9%a2%98%e7%9a%84%e4%b8%80%e4%ba%9b%e6%83%b3%e6%b3%95&amp;url=https%3a%2f%2fair.googol.im%2fposts%2fgotour-exercise-web-crawl%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 关于gotour最后一题的一些想法 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e5%85%b3%e4%ba%8egotour%e6%9c%80%e5%90%8e%e4%b8%80%e9%a2%98%e7%9a%84%e4%b8%80%e4%ba%9b%e6%83%b3%e6%b3%95&u=https%3a%2f%2fair.googol.im%2fposts%2fgotour-exercise-web-crawl%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//air-g.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://air.googol.im/>Air On G</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>