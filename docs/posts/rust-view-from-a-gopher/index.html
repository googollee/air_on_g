<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>一个Go开发者的Rust体验 | Air On G</title>
<meta name=keywords content="rust,go"><meta name=description content="一直很关注Rust这门语言的发展，不过没有实际使用过。最近Rust准备以2018 Rust的名义发布可以用作生产环境的稳定版本，又赶上有兴趣写点东西，所以把一个基础模块同时用Rust和Go实现了一下。本文就是这次实现的一些结果。
我自己有很长的Go使用经历，所以本文对Go的看法会相对比较准确。Rust虽然关注了很长时间，但代码基本上是最近一个星期左右的成果，可能看法有偏颇。"><meta name=author content="Googol Lee"><link rel=canonical href=https://air.googol.im/posts/rust-view-from-a-gopher/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://air.googol.im/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://air.googol.im/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://air.googol.im/favicon-32x32.png><link rel=apple-touch-icon href=https://air.googol.im/apple-touch-icon.png><link rel=mask-icon href=https://air.googol.im/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://air.googol.im/posts/rust-view-from-a-gopher/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-BX4XDRKHQ9"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BX4XDRKHQ9")}</script><meta property="og:title" content="一个Go开发者的Rust体验"><meta property="og:description" content="一直很关注Rust这门语言的发展，不过没有实际使用过。最近Rust准备以2018 Rust的名义发布可以用作生产环境的稳定版本，又赶上有兴趣写点东西，所以把一个基础模块同时用Rust和Go实现了一下。本文就是这次实现的一些结果。
我自己有很长的Go使用经历，所以本文对Go的看法会相对比较准确。Rust虽然关注了很长时间，但代码基本上是最近一个星期左右的成果，可能看法有偏颇。"><meta property="og:type" content="article"><meta property="og:url" content="https://air.googol.im/posts/rust-view-from-a-gopher/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-07-21T11:10:00+02:00"><meta property="article:modified_time" content="2018-07-21T11:10:00+02:00"><meta property="og:site_name" content="Air On G"><meta name=twitter:card content="summary"><meta name=twitter:title content="一个Go开发者的Rust体验"><meta name=twitter:description content="一直很关注Rust这门语言的发展，不过没有实际使用过。最近Rust准备以2018 Rust的名义发布可以用作生产环境的稳定版本，又赶上有兴趣写点东西，所以把一个基础模块同时用Rust和Go实现了一下。本文就是这次实现的一些结果。
我自己有很长的Go使用经历，所以本文对Go的看法会相对比较准确。Rust虽然关注了很长时间，但代码基本上是最近一个星期左右的成果，可能看法有偏颇。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://air.googol.im/posts/"},{"@type":"ListItem","position":2,"name":"一个Go开发者的Rust体验","item":"https://air.googol.im/posts/rust-view-from-a-gopher/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"一个Go开发者的Rust体验","name":"一个Go开发者的Rust体验","description":"一直很关注Rust这门语言的发展，不过没有实际使用过。最近Rust准备以2018 Rust的名义发布可以用作生产环境的稳定版本，又赶上有兴趣写点东西，所以把一个基础模块同时用Rust和Go实现了一下。本文就是这次实现的一些结果。\n我自己有很长的Go使用经历，所以本文对Go的看法会相对比较准确。Rust虽然关注了很长时间，但代码基本上是最近一个星期左右的成果，可能看法有偏颇。\n","keywords":["rust","go"],"articleBody":"一直很关注Rust这门语言的发展，不过没有实际使用过。最近Rust准备以2018 Rust的名义发布可以用作生产环境的稳定版本，又赶上有兴趣写点东西，所以把一个基础模块同时用Rust和Go实现了一下。本文就是这次实现的一些结果。\n我自己有很长的Go使用经历，所以本文对Go的看法会相对比较准确。Rust虽然关注了很长时间，但代码基本上是最近一个星期左右的成果，可能看法有偏颇。\n这次对比的内容是实现一个针对短字符串优化的字符串。在反序列化时，由于字符串长度未知，导致反序列化时需要根据接收到的字符串创建一段内存来容纳内容。不过一般情况下，反序列化时的字符串长度都较小，由此导致反复申请释放内存，会消耗很多性能。短字符串的优化是，针对某个长度的字符串，提前分配好内存，如果反序列化的长度不足这个长度，直接使用分配好的内存存储内容，不再申请内存，也就没有了释放过程，从而提高效率。\n由于我对Go更加熟悉，所以首先使用Go实现了这个功能：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 const prealloc_size = 20 type String struct { data [prealloc_size]byte buf []byte } func (s *String) fill(r io.Reader, n uint) error { if n \u003e prealloc_size { s.buf = make([]byte, n) } else { s.buf = s.data[:n] } _, err := io.ReadFull(r, s.buf) return err } func (s *String) String() string { return *(*string)(unsafe.Pointer(\u0026s.buf)) } 这段代码相当直白，不做过多介绍。唯一值得一提的是String.String()方法，利用unsafe来将buf直接当做字符串，避免再次分配内存。具体可以参考官方库的strings.Builder.String()方法。\n既然要测试性能，必然要有相关的性能测试代码。为了简洁，这里就不展示单元测试的内容了：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 const ( shortStr = \"short str\" longStr = \"loooooooooonnnnnnnnnngggggggg string\" ) func BenchmarkShortString(b *testing.B) { b.StopTimer() var str String data := []byte(shortStr) r := bytes.NewReader(data) l := uint(len(data)) b.StartTimer() for i := 0; i \u003c b.N; i++ { r.Reset(data) str.fill(r, l) str.String() } } func BenchmarkLongString(b *testing.B) { b.StopTimer() var str String data := []byte(longStr) r := bytes.NewReader(data) l := uint(len(data)) b.StartTimer() for i := 0; i \u003c b.N; i++ { r.Reset(data) str.fill(r, l) str.String() } } 测试结果如下：\n1 2 3 4 5 6 7 8 $ go test -bench . -benchmem goos: darwin goarch: amd64 pkg: github.com/googollee/rtnx/rtmp/amf BenchmarkShortString-4 50000000\t25.1 ns/op\t0 B/op\t0 allocs/op BenchmarkLongString-4 20000000\t67.0 ns/op\t48 B/op\t1 allocs/op PASS ok github.com/googollee/rtnx/rtmp/amf\t3.189s 可以看到，短字符串在测试中确实没有再次分配内存，并且相比长字符串，性能有了显著提高。\n之后，先是对这段代码直接翻译为Rust。但在翻译过程中遇到了不少问题。\n首先遇到的问题，当然是所有权的问题！Go结构里的buf实际有两种引用：要么引用内部data的一段内存，要么引用一段分配的内存。而Rust，基本上没办法让一个struct在内部互相引用。Rust强制所有引用必须以树状组织所有权，而内部引用这种情况，相当于一个节点内引用自己，没办法形成树状所有权。所以需要将这个域拆成两个，一个表示在引用data时，需要引用多长的地址，另一个表示如果有必要，引用到一段分配的内存。第一次尝试如下：\n1 2 3 4 5 pub struct String { data: [u8; 20], heap: Option\u003cBox\u003c[u8]\u003e\u003e, len: usize, } 本来是想利用Rust的模版，将预先分配的内存长度参数化。结果试了很久，发现Rust还不支持常数模版，所以这里20的长度直接硬编码。好在后面的实现不会直接依赖20这个数，所以没有做进一步改动。\nRust社区使用类似String\u003c[u8; 20]\u003e的方式来实现常数模版参数。这是一个workaround。目前Rust官方已经有常数模版的提案。\n其中data和之前一样，是预先分配的一段内存。len用来记录，在短字符串的情况下，使用了多长的data的内容。由于去掉了引用关系，所以不会违反Rust的所有权。\n但下一个问题，heap应该如何定义？Rust规定，所有的引用都必须指向相应的引用对象，不能出现没有引用的引用变量，因此\u0026 T是不能为空的。而我希望heap在正常情况下需要为空。因此这里使用Option\u003c_\u003e来表示一个要么为None，要么有值的类型。\n接下来的Box\u003c_\u003e表示持有一个在堆上分配的类型。与Go不同，Rust非常明确的区分堆变量和栈变量，而Go通过编译器的逃逸分析，会自己决定一个变量是否需要放到堆上并在之后由GC回收。这体现了两种语言完全不同的思路：Go试图降低程序员需要了解的实现细节，提供尽量少但足够的基础设施，保证上手容易的同时保证性能；而Rust则暴露了大量的细节给程序员，并强迫程序员遵守约束，并使用这些约束保证程序正确。由于Rust暴露了实现细节，有经验的用户可以根据这些细节做更激进的优化。而Go很多时候受限编译器的能力无法实现（很多时候是不知道可以进行）这类优化。比如Go在读取链接时常会开一段临时内存进行存储：\n1 2 3 4 5 6 func Handle(r io.Reader) { // ... var data [20]byte r.Read(data[:]) // ... } 其中data就是临时分配的内存。理论上，这段内存如果只在Handle中使用，只在栈上就可以，随着Handle退出自动释放。但是由于逃逸分析无法获知是否在r.Read()时持有了data[:]这个引用，这里会认为data有逃逸，所以会将其分配在堆上，并导致后面gc的参与。\n回到Rust，最终，heap被定义为Option","wordCount":"911","inLanguage":"en","datePublished":"2018-07-21T11:10:00+02:00","dateModified":"2018-07-21T11:10:00+02:00","author":{"@type":"Person","name":"Googol Lee"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://air.googol.im/posts/rust-view-from-a-gopher/"},"publisher":{"@type":"Organization","name":"Air On G","logo":{"@type":"ImageObject","url":"https://air.googol.im/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://air.googol.im/ accesskey=h title="Air On G (Alt + H)">Air On G</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://air.googol.im/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://air.googol.im/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://air.googol.im/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://air.googol.im/>Home</a>&nbsp;»&nbsp;<a href=https://air.googol.im/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">一个Go开发者的Rust体验</h1><div class=post-meta><span title='2018-07-21 11:10:00 +0200 CEST'>2018-07-21</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Googol Lee</div></header><div class=post-content><p>一直很关注Rust这门语言的发展，不过没有实际使用过。最近Rust准备以2018 Rust的名义发布可以用作生产环境的稳定版本，又赶上有兴趣写点东西，所以把一个基础模块同时用Rust和Go实现了一下。本文就是这次实现的一些结果。</p><p>我自己有很长的Go使用经历，所以本文对Go的看法会相对比较准确。Rust虽然关注了很长时间，但代码基本上是最近一个星期左右的成果，可能看法有偏颇。</p><p>这次对比的内容是实现一个针对短字符串优化的字符串。在反序列化时，由于字符串长度未知，导致反序列化时需要根据接收到的字符串创建一段内存来容纳内容。不过一般情况下，反序列化时的字符串长度都较小，由此导致反复申请释放内存，会消耗很多性能。短字符串的优化是，针对某个长度的字符串，提前分配好内存，如果反序列化的长度不足这个长度，直接使用分配好的内存存储内容，不再申请内存，也就没有了释放过程，从而提高效率。</p><p>由于我对Go更加熟悉，所以首先使用Go实现了这个功能：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=nx>prealloc_size</span> <span class=p>=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>String</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=p>[</span><span class=nx>prealloc_size</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>  <span class=nx>buf</span>  <span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>String</span><span class=p>)</span> <span class=nf>fill</span><span class=p>(</span><span class=nx>r</span> <span class=nx>io</span><span class=p>.</span><span class=nx>Reader</span><span class=p>,</span> <span class=nx>n</span> <span class=kt>uint</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>n</span> <span class=p>&gt;</span> <span class=nx>prealloc_size</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>buf</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>buf</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>data</span><span class=p>[:</span><span class=nx>n</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>ReadFull</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>String</span><span class=p>)</span> <span class=nf>String</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=kt>string</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>s</span><span class=p>.</span><span class=nx>buf</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这段代码相当直白，不做过多介绍。唯一值得一提的是<code>String.String()</code>方法，利用<code>unsafe</code>来将<code>buf</code>直接当做字符串，避免再次分配内存。具体可以参考官方库的<code>strings.Builder.String()</code>方法。</p><p>既然要测试性能，必然要有相关的性能测试代码。为了简洁，这里就不展示单元测试的内容了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span><span class=lnt id=hl-1-15><a class=lnlinks href=#hl-1-15>15</a>
</span><span class=lnt id=hl-1-16><a class=lnlinks href=#hl-1-16>16</a>
</span><span class=lnt id=hl-1-17><a class=lnlinks href=#hl-1-17>17</a>
</span><span class=lnt id=hl-1-18><a class=lnlinks href=#hl-1-18>18</a>
</span><span class=lnt id=hl-1-19><a class=lnlinks href=#hl-1-19>19</a>
</span><span class=lnt id=hl-1-20><a class=lnlinks href=#hl-1-20>20</a>
</span><span class=lnt id=hl-1-21><a class=lnlinks href=#hl-1-21>21</a>
</span><span class=lnt id=hl-1-22><a class=lnlinks href=#hl-1-22>22</a>
</span><span class=lnt id=hl-1-23><a class=lnlinks href=#hl-1-23>23</a>
</span><span class=lnt id=hl-1-24><a class=lnlinks href=#hl-1-24>24</a>
</span><span class=lnt id=hl-1-25><a class=lnlinks href=#hl-1-25>25</a>
</span><span class=lnt id=hl-1-26><a class=lnlinks href=#hl-1-26>26</a>
</span><span class=lnt id=hl-1-27><a class=lnlinks href=#hl-1-27>27</a>
</span><span class=lnt id=hl-1-28><a class=lnlinks href=#hl-1-28>28</a>
</span><span class=lnt id=hl-1-29><a class=lnlinks href=#hl-1-29>29</a>
</span><span class=lnt id=hl-1-30><a class=lnlinks href=#hl-1-30>30</a>
</span><span class=lnt id=hl-1-31><a class=lnlinks href=#hl-1-31>31</a>
</span><span class=lnt id=hl-1-32><a class=lnlinks href=#hl-1-32>32</a>
</span><span class=lnt id=hl-1-33><a class=lnlinks href=#hl-1-33>33</a>
</span><span class=lnt id=hl-1-34><a class=lnlinks href=#hl-1-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>shortStr</span> <span class=p>=</span> <span class=s>&#34;short str&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>longStr</span>  <span class=p>=</span> <span class=s>&#34;loooooooooonnnnnnnnnngggggggg string&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>BenchmarkShortString</span><span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>B</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>.</span><span class=nf>StopTimer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>str</span> <span class=nx>String</span>
</span></span><span class=line><span class=cl>	<span class=nx>data</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>shortStr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span> <span class=o>:=</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewReader</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span> <span class=o>:=</span> <span class=nb>uint</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>.</span><span class=nf>StartTimer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>r</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>str</span><span class=p>.</span><span class=nf>fill</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>str</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>BenchmarkLongString</span><span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>B</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>.</span><span class=nf>StopTimer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>str</span> <span class=nx>String</span>
</span></span><span class=line><span class=cl>	<span class=nx>data</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>longStr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span> <span class=o>:=</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewReader</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span> <span class=o>:=</span> <span class=nb>uint</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>.</span><span class=nf>StartTimer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>r</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>str</span><span class=p>.</span><span class=nf>fill</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>str</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>测试结果如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5>5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6>6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7>7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ go <span class=nb>test</span> -bench . -benchmem
</span></span><span class=line><span class=cl>goos: darwin
</span></span><span class=line><span class=cl>goarch: amd64
</span></span><span class=line><span class=cl>pkg: github.com/googollee/rtnx/rtmp/amf
</span></span><span class=line><span class=cl>BenchmarkShortString-4    	50000000	        25.1 ns/op	       <span class=m>0</span> B/op	       <span class=m>0</span> allocs/op
</span></span><span class=line><span class=cl>BenchmarkLongString-4     	20000000	        67.0 ns/op	      <span class=m>48</span> B/op	       <span class=m>1</span> allocs/op
</span></span><span class=line><span class=cl>PASS
</span></span><span class=line><span class=cl>ok  	github.com/googollee/rtnx/rtmp/amf	3.189s
</span></span></code></pre></td></tr></table></div></div><p>可以看到，短字符串在测试中确实没有再次分配内存，并且相比长字符串，性能有了显著提高。</p><p>之后，先是对这段代码直接翻译为Rust。但在翻译过程中遇到了不少问题。</p><p>首先遇到的问题，当然是所有权的问题！Go结构里的<code>buf</code>实际有两种引用：要么引用内部<code>data</code>的一段内存，要么引用一段分配的内存。而Rust，基本上没办法让一个struct在内部互相引用。Rust强制所有引用必须以树状组织所有权，而内部引用这种情况，相当于一个节点内引用自己，没办法形成树状所有权。所以需要将这个域拆成两个，一个表示在引用<code>data</code>时，需要引用多长的地址，另一个表示如果有必要，引用到一段分配的内存。第一次尝试如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3>3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4>4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nb>String</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>data</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>20</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>heap</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>Box</span><span class=o>&lt;</span><span class=p>[</span><span class=kt>u8</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>len</span>: <span class=kt>usize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>本来是想利用Rust的模版，将预先分配的内存长度参数化。结果试了很久，发现Rust还不支持常数模版，所以这里20的长度直接硬编码。好在后面的实现不会直接依赖20这个数，所以没有做进一步改动。</p><p>Rust社区使用类似<code>String&lt;[u8; 20]></code>的方式来实现常数模版参数。这是一个workaround。目前Rust官方已经有常数模版的<a href=https://github.com/rust-lang/rust/issues/44580>提案</a>。</p></blockquote><p>其中<code>data</code>和之前一样，是预先分配的一段内存。<code>len</code>用来记录，在短字符串的情况下，使用了多长的<code>data</code>的内容。由于去掉了引用关系，所以不会违反Rust的所有权。</p><p>但下一个问题，<code>heap</code>应该如何定义？Rust规定，所有的引用都必须指向相应的引用对象，不能出现没有引用的引用变量，因此<code>& T</code>是不能为空的。而我希望<code>heap</code>在正常情况下需要为空。因此这里使用<code>Option&lt;_></code>来表示一个要么为<code>None</code>，要么有值的类型。</p><p>接下来的<code>Box&lt;_></code>表示持有一个在堆上分配的类型。与Go不同，Rust非常明确的区分堆变量和栈变量，而Go通过编译器的逃逸分析，会自己决定一个变量是否需要放到堆上并在之后由GC回收。这体现了两种语言完全不同的思路：Go试图降低程序员需要了解的实现细节，提供尽量少但足够的基础设施，保证上手容易的同时保证性能；而Rust则暴露了大量的细节给程序员，并强迫程序员遵守约束，并使用这些约束保证程序正确。由于Rust暴露了实现细节，有经验的用户可以根据这些细节做更激进的优化。而Go很多时候受限编译器的能力无法实现（很多时候是不知道可以进行）这类优化。比如Go在读取链接时常会开一段临时内存进行存储：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2>2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3>3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4>4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5>5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Handle</span><span class=p>(</span><span class=nx>r</span> <span class=nx>io</span><span class=p>.</span><span class=nx>Reader</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>var</span> <span class=nx>data</span> <span class=p>[</span><span class=mi>20</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>  <span class=nx>r</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nx>data</span><span class=p>[:])</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其中<code>data</code>就是临时分配的内存。理论上，这段内存如果只在<code>Handle</code>中使用，只在栈上就可以，随着<code>Handle</code>退出自动释放。但是由于逃逸分析无法获知是否在<code>r.Read()</code>时持有了<code>data[:]</code>这个引用，这里会认为<code>data</code>有逃逸，所以会将其分配在堆上，并导致后面gc的参与。</p><p>回到Rust，最终，<code>heap</code>被定义为<code>Option&lt;Box&lt;[u8]>></code>，表示一个可以为<code>None</code>，也可以是一个分配在堆上的<code>[u8]</code>。<code>[u8]</code>这个类型与Go的slice从概念到实现都很类似，是对数组的一种引用。值得注意的是，<code>[u8]</code>由于无法在编译时预知引用的长度，所以无法直接在栈上创建一个<code>[u8]</code>的变量。</p><p>接下来是<code>fill()</code>方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a class=lnlinks href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a class=lnlinks href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a class=lnlinks href=#hl-5-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>fill</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>r</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=k>impl</span><span class=w> </span><span class=n>io</span>::<span class=n>Read</span><span class=p>,</span><span class=w> </span><span class=n>n</span>: <span class=kt>usize</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>len</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Vec</span>::<span class=n>with_capacity</span><span class=p>(</span><span class=n>n</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>set_len</span><span class=p>(</span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>heap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=n>into_boxed_slice</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>heap</span><span class=p>.</span><span class=n>as_mut</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;should not here&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=o>..</span><span class=n>n</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>read_full</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Rust默认保证变量使用时必须做过初始化，而这里<code>Vec::with_capacity()</code>分配内存后，并不需要确定数据的内容，随后会填入具体数据，所以使用<code>unsafe { v.set_len(n) }</code>来强制使用该段未初始化的内存。值得注意的是，当使用<code>v.into_boxed_slice()</code>将这段内存的所有权交给<code>self.heap</code>后，需要有一种方法再取回这段内存的引用，并赋给<code>buf</code>变量。<code>self.heap</code>的类型是<code>Option&lt;Box&lt;[u8]>></code>，按照习惯，需要按照<code>Option&lt;Box&lt;[u8]>> -> Box&lt;[u8]> -> [u8] -> &amp;mut [u8]</code>的顺序取得引用。但是这里有个问题，如果变成了<code>Box&lt;[u8]></code>，证明这是一个自己拥有生命周期的变量类型，而不是一个引用。所以这里的取引用的顺序是<code>Option&lt;Box&lt;[u8]>> -> Option&lt;&amp;mut Box&lt;[u8]>> -> &amp;mut Box&lt;[u8]> -> &amp;mut [u8]</code>。而第一步就是通过<code>self.heap.as_mut()</code>来取得引用。</p><p>由于Rust没有官方的<code>io.ReadFull()</code>，所以这里做了自己的实现：经<a href=https://twitter.com/upsuper>@upsuper</a>提醒，Rust官方有类似的实现<code>std::io::Read::read_exact</code>。不过这里依旧使用自己的实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>read_full</span><span class=p>(</span><span class=n>r</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=k>impl</span><span class=w> </span><span class=n>io</span>::<span class=n>Read</span><span class=p>,</span><span class=w> </span><span class=n>b</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=p>[</span><span class=kt>u8</span><span class=p>])</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>len</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>b</span><span class=p>[</span><span class=n>i</span><span class=o>..</span><span class=p>])</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>b</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(</span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>io::Result&lt;()></code>是很展现Rust特色的类型。这个类型是表示一个要么是<code>()</code>的类型值，要么是<code>io::Error&lt;_></code>的类型值。<code>()</code>类型是Rust里的某种元类型，某种程度上可以看作是<code>nil</code>类型或者表示不需要关心的返回值。<code>io::Error&lt;_></code>就很简单，是表示某种io的错误，具体错误类型由模版类型<code>_</code>决定。对比Go的类型：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ReadFull</span><span class=p>(</span><span class=nx>r</span> <span class=nx>io</span><span class=p>.</span><span class=nx>Reader</span><span class=p>,</span> <span class=nx>n</span> <span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>显然，Go的类型无法在语法上保证<code>ReadFull()</code>同时返回<code>int</code>和<code>error</code>。而同时返回两个值会造成调用者困惑：到底这是个正常返回，还是个错误？不要以为Go里常用<code>error</code>后置的约定，就不会出现这种情况。实际上Go标准库都无法防止这种情况<a href=https://godoc.org/io#Reader>出现</a>：</p><blockquote><p>When Read encounters an error or end-of-file condition after successfully reading n > 0 bytes, it returns the number of bytes read. It may return the (non-nil) error from the same call or return the error (and n == 0) from a subsequent call. An instance of this general case is that a Reader returning a non-zero number of bytes at the end of the input stream may return either err == EOF or err == nil. The next Read should return 0, EOF.</p></blockquote><p>而对这种类型错误的处理，简单处理可以直接<code>unwrap()</code>（后面会有展示），这里使用<code>match</code>是更精细的处理。由于<code>match</code>是个表达式而不是语句，所以可以使用下面的方法处理错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2>2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3>3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4>4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5>5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6>6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>function</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nb>Err</span><span class=p>(</span><span class=n>err</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// handle err
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>err</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nb>Ok</span><span class=p>(</span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>与Go的错误处理对比：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1>1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2>2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3>3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4>4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ret</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>function</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// handle err
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Rust错误处理的优点是不会出现<code>err</code>变量四处定义的现象，不过Go代码量更少。不过，借助Rust的宏，如果不需要特别处理返回错误err，而是直接返回的话，Rust可以简写为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>function</span><span class=p>()</span><span class=o>?</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这就显得比Go好看多了。即便是预期中<a href=https://github.com/gopherchina/conference/blob/3a0f94003da58e09c5acfa926a604643f6846491/2018/3.%20Rethinking%20Errors%20for%20Go%202.pdf>Go2的错误处理</a>都并不比这个好。</p><p>接下来是性能测试部分。我不知道Rust对于<em>工程</em>这件事情是怎么理解的，反正在我实验时，Cargo项目在stable分支支持<code>bench</code>命令，但却依赖nightly的一个testing包才能用。目前的Rust项目里充满了这种奇怪的，号称stable提供但却依赖nightly的特性，导致构建完整工程时十分痛苦。与Go自带非常稳定的<code>testing.B</code>特性相比，Rust这方面感觉一点都不像一个有着合理规划的号称稳定版三年之久的项目。</p><p>最终，使用<a href=https://github.com/japaric/criterion.rs>Criterion</a>项目完成整个性能测试，代价是性能测试代码与<code>String</code>定义代码分在不同目录，且没办法引用<code>String</code>类型的私有方法。这也是上面将<code>fill()</code>定义为<code>pub</code>的原因。测试代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a>
</span><span class=lnt id=hl-11-13><a class=lnlinks href=#hl-11-13>13</a>
</span><span class=lnt id=hl-11-14><a class=lnlinks href=#hl-11-14>14</a>
</span><span class=lnt id=hl-11-15><a class=lnlinks href=#hl-11-15>15</a>
</span><span class=lnt id=hl-11-16><a class=lnlinks href=#hl-11-16>16</a>
</span><span class=lnt id=hl-11-17><a class=lnlinks href=#hl-11-17>17</a>
</span><span class=lnt id=hl-11-18><a class=lnlinks href=#hl-11-18>18</a>
</span><span class=lnt id=hl-11-19><a class=lnlinks href=#hl-11-19>19</a>
</span><span class=lnt id=hl-11-20><a class=lnlinks href=#hl-11-20>20</a>
</span><span class=lnt id=hl-11-21><a class=lnlinks href=#hl-11-21>21</a>
</span><span class=lnt id=hl-11-22><a class=lnlinks href=#hl-11-22>22</a>
</span><span class=lnt id=hl-11-23><a class=lnlinks href=#hl-11-23>23</a>
</span><span class=lnt id=hl-11-24><a class=lnlinks href=#hl-11-24>24</a>
</span><span class=lnt id=hl-11-25><a class=lnlinks href=#hl-11-25>25</a>
</span><span class=lnt id=hl-11-26><a class=lnlinks href=#hl-11-26>26</a>
</span><span class=lnt id=hl-11-27><a class=lnlinks href=#hl-11-27>27</a>
</span><span class=lnt id=hl-11-28><a class=lnlinks href=#hl-11-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[macro_use]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=k>crate</span><span class=w> </span><span class=n>criterion</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=k>crate</span><span class=w> </span><span class=n>rtnx</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>criterion</span>::<span class=n>Criterion</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rtnx</span>::<span class=n>rtmp</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>string</span><span class=p>(</span><span class=n>c</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Criterion</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>c</span><span class=p>.</span><span class=n>bench_function</span><span class=p>(</span><span class=s>&#34;short str&#34;</span><span class=p>,</span><span class=w> </span><span class=o>|</span><span class=n>b</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=kt>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>data</span>: <span class=kp>&amp;</span><span class=nb>&#39;static</span> <span class=kt>str</span> <span class=o>=</span><span class=w> </span><span class=s>&#34;short str&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>b</span><span class=p>.</span><span class=n>iter</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>str</span><span class=p>.</span><span class=n>fill</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>as_bytes</span><span class=p>(),</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>len</span><span class=p>()).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>str</span><span class=p>.</span><span class=n>string</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>c</span><span class=p>.</span><span class=n>bench_function</span><span class=p>(</span><span class=s>&#34;long str&#34;</span><span class=p>,</span><span class=w> </span><span class=o>|</span><span class=n>b</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=kt>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>data</span>: <span class=kp>&amp;</span><span class=nb>&#39;static</span> <span class=kt>str</span> <span class=o>=</span><span class=w> </span><span class=s>&#34;loooooooooooooooooonnnnnnnnnnnnng str&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>b</span><span class=p>.</span><span class=n>iter</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>str</span><span class=p>.</span><span class=n>fill</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>as_bytes</span><span class=p>(),</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>len</span><span class=p>()).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>str</span><span class=p>.</span><span class=n>string</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Rust本身为<code>&[u8]</code>类型实现了<code>Read</code>，所以可以直接将<code>data.as_bytes()</code>作为一个<code>Read</code>使用。由于<code>fill()</code>需求的是<code>&amp;mut Read</code>，这里会使用<code>&amp;mut data.as_bytes()</code>。而<code>'static</code>表示静态生命周期，也就是常量字符串。</p><p>测试结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10>10</a>
</span><span class=lnt id=hl-12-11><a class=lnlinks href=#hl-12-11>11</a>
</span><span class=lnt id=hl-12-12><a class=lnlinks href=#hl-12-12>12</a>
</span><span class=lnt id=hl-12-13><a class=lnlinks href=#hl-12-13>13</a>
</span><span class=lnt id=hl-12-14><a class=lnlinks href=#hl-12-14>14</a>
</span><span class=lnt id=hl-12-15><a class=lnlinks href=#hl-12-15>15</a>
</span><span class=lnt id=hl-12-16><a class=lnlinks href=#hl-12-16>16</a>
</span><span class=lnt id=hl-12-17><a class=lnlinks href=#hl-12-17>17</a>
</span><span class=lnt id=hl-12-18><a class=lnlinks href=#hl-12-18>18</a>
</span><span class=lnt id=hl-12-19><a class=lnlinks href=#hl-12-19>19</a>
</span><span class=lnt id=hl-12-20><a class=lnlinks href=#hl-12-20>20</a>
</span><span class=lnt id=hl-12-21><a class=lnlinks href=#hl-12-21>21</a>
</span><span class=lnt id=hl-12-22><a class=lnlinks href=#hl-12-22>22</a>
</span><span class=lnt id=hl-12-23><a class=lnlinks href=#hl-12-23>23</a>
</span><span class=lnt id=hl-12-24><a class=lnlinks href=#hl-12-24>24</a>
</span><span class=lnt id=hl-12-25><a class=lnlinks href=#hl-12-25>25</a>
</span><span class=lnt id=hl-12-26><a class=lnlinks href=#hl-12-26>26</a>
</span><span class=lnt id=hl-12-27><a class=lnlinks href=#hl-12-27>27</a>
</span><span class=lnt id=hl-12-28><a class=lnlinks href=#hl-12-28>28</a>
</span><span class=lnt id=hl-12-29><a class=lnlinks href=#hl-12-29>29</a>
</span><span class=lnt id=hl-12-30><a class=lnlinks href=#hl-12-30>30</a>
</span><span class=lnt id=hl-12-31><a class=lnlinks href=#hl-12-31>31</a>
</span><span class=lnt id=hl-12-32><a class=lnlinks href=#hl-12-32>32</a>
</span><span class=lnt id=hl-12-33><a class=lnlinks href=#hl-12-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ cargo bench
</span></span><span class=line><span class=cl>    Finished release <span class=o>[</span>optimized<span class=o>]</span> target<span class=o>(</span>s<span class=o>)</span> in 0.27s
</span></span><span class=line><span class=cl>     Running target/release/deps/rtnx-b3fb2c92c52ff0ff
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>running <span class=m>1</span> <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=nb>test</span> rtmp::amf::string_test::test_string ... ignored
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>test</span> result: ok. <span class=m>0</span> passed<span class=p>;</span> <span class=m>0</span> failed<span class=p>;</span> <span class=m>1</span> ignored<span class=p>;</span> <span class=m>0</span> measured<span class=p>;</span> <span class=m>0</span> filtered out
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     Running target/release/deps/rtnx-b073d7725e43e2cb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>running <span class=m>1</span> <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=nb>test</span> rtmp::amf::string_test::test_string ... ignored
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>test</span> result: ok. <span class=m>0</span> passed<span class=p>;</span> <span class=m>0</span> failed<span class=p>;</span> <span class=m>1</span> ignored<span class=p>;</span> <span class=m>0</span> measured<span class=p>;</span> <span class=m>0</span> filtered out
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     Running target/release/deps/string-e1abdea77166d91b
</span></span><span class=line><span class=cl>Gnuplot not found, disabling plotting
</span></span><span class=line><span class=cl>short str               time:   <span class=o>[</span>8.8030 ns 8.8762 ns 8.9604 ns<span class=o>]</span>                       
</span></span><span class=line><span class=cl>                        change: <span class=o>[</span>-2.0804% +0.0430% +1.9924%<span class=o>]</span> <span class=o>(</span><span class=nv>p</span> <span class=o>=</span> 0.96 &gt; 0.05<span class=o>)</span>
</span></span><span class=line><span class=cl>                        No change in performance detected.
</span></span><span class=line><span class=cl>Found <span class=m>12</span> outliers among <span class=m>100</span> measurements <span class=o>(</span>12.00%<span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=m>8</span> <span class=o>(</span>8.00%<span class=o>)</span> high mild
</span></span><span class=line><span class=cl>  <span class=m>4</span> <span class=o>(</span>4.00%<span class=o>)</span> high severe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>long str                time:   <span class=o>[</span>29.893 ns 30.005 ns 30.156 ns<span class=o>]</span>                      
</span></span><span class=line><span class=cl>                        change: <span class=o>[</span>-0.1391% +0.6297% +1.4001%<span class=o>]</span> <span class=o>(</span><span class=nv>p</span> <span class=o>=</span> 0.12 &gt; 0.05<span class=o>)</span>
</span></span><span class=line><span class=cl>                        No change in performance detected.
</span></span><span class=line><span class=cl>Found <span class=m>6</span> outliers among <span class=m>100</span> measurements <span class=o>(</span>6.00%<span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=m>3</span> <span class=o>(</span>3.00%<span class=o>)</span> high mild
</span></span><span class=line><span class=cl>  <span class=m>3</span> <span class=o>(</span>3.00%<span class=o>)</span> high severe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Gnuplot not found, disabling plotting
</span></span></code></pre></td></tr></table></div></div><p>与之前Go的测试结果对比：</p><table><thead><tr><th style=text-align:left>语言</th><th style=text-align:left>短字符串</th><th style=text-align:left>长字符串</th></tr></thead><tbody><tr><td style=text-align:left>Rust</td><td style=text-align:left>8.8762ns</td><td style=text-align:left>30.005ns</td></tr><tr><td style=text-align:left>Go</td><td style=text-align:left>25.1ns</td><td style=text-align:left>67.0ns</td></tr></tbody></table><p>Rust在两种情况都只用了Go不到一半的时间。Rust在性能方面确实完胜Go。</p><p>一些上面没有提到的事情。</p><p>首先是并发。Go自带并发，可以简单使用<code>go/chan</code>来做到高效且资源消耗小的并发。Rust语言层面没有这个支持，但是凭借灵活的类型系统，通过Future类型为并发提供了基础设施。在此之上，<a href=https://tokio.rs/>tokio</a>实现了类似goroutine的一套并发机制。由于Go的类型系统过于简单，是没办法以库的方式实现并发的。这一点，Rust做的非常漂亮。</p><p>关于包，与Go基于目录的package相比，Rust就充满了没有必要的复杂性。Rust里通过<code>mod name</code>可以引入另一个编译单元name，这个单元可以是同目录下的文件<code>name.rs</code>，也可以是子目录下的文件<code>name/mod.rs</code>。而<code>mod</code>本身还会生成一个<code>name</code>的命名空间，如果要引用包里的符号，要么通过<code>use</code>引入符号，要么带着<code>name::</code>作为符号前缀给出命名空间。这导致想将一个包里的代码分到不同文件时，变得异常复杂。基本上，想要做到拆分文件又能互相引用，需要写类似下面的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2>2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3>3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4>4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>mod</span> <span class=nn>part1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>part2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=bp>self</span>::<span class=n>part1</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=bp>self</span>::<span class=n>part2</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>而这还会导致<code>part1</code>和<code>part2</code>里的私有符号互相不可见。<code>mod/use</code>这一特性看似灵活，实际最终会强制一个包的内容全部写到一个文件里。与Go自然的“一个包一个目录”的形式相比，理解和使用都会困难很多。而Rust 2018也试图改进这个问题，细节可以查看<a href=https://rust-lang-nursery.github.io/edition-guide/2018/transitioning/modules/path-clarity.html>Path clarity</a>。</p><p>Rust对编译单元的控制，是依靠宏指令来完成的。比如如果说一部分代码只在测试时编译，就需要写：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1>1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2>2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3>3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[cfg(test)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>tests</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这样<code>mod tests</code>内部的代码就只会在<code>test</code>时才做编译。而Go使用文件后缀来做这种区分。比如<code>xxx_test.go</code>默认只在测试是编译。这里我认为Go的方式更自然。一个包里有哪些编译控制，哪个文件会在哪个状态用到，直接看文件名就能知道。类似<code>xxx_unix.go/yyy_windows.go</code>也为维护提供了方便。Rust如果没有合适的工具的话，就只能一个一个文件查看，才能知道编译规则。</p><p>说道工具，Rust工具链的质量和Go相比，可以用惨不忍睹来形容。上文提到的性能测试就是一例。Rust大量工具目前处于preview或者只提供nightly的地步（好像最近clippy刚刚进入到stable的preview状态）。Rust社区希望2018能够提供一个稳定生产力的版本<a href=https://rust-lang-nursery.github.io/edition-guide/2018/index.html>Rust 2018</a>，不过现在2018都已经过半，还有一部分语法工作没有合并到stable。这不得不想起当年C++ 98拖到C++ 00再拖到C++ 0x。希望Rust能在发布语言版本的时候，考虑一部分核心工具链的同时发布。Rust社区将2018版本的发布时间定在10月，目前各个项目与预期进度相符。希望在今年底能看到更具生产力的稳定版本，不仅仅是语言的特性，还包括关键工具链。</p><p>至于工程项目，cargo做的很好。Go目前的<code>GOPATH</code>模式，大概只有Google自己觉得好。好在Go modules已经<a href=https://groups.google.com/forum/#!topic/golang-dev/a5PqQuBljF4>箭在弦上</a>，马上就不用忍受这么难用的功能了。</p><p>最后的总结。</p><p>Rust和Go是完完全全两个思路下的语言。Go会尽力优化开发流程，减少暴露给程序员的概念，并有足够稳定的接口。而Rust则将所有特性暴露给程序员做选择，语言社区只负责核心编译器，将最佳实践固化为语言特性，工具链交由社区进行完善。</p><p>我建议所有的Go程序员去尝试一下Rust，体会一下编译器如何强制要求理解程序的细节。这些细节是Go试图隐藏的复杂性，但是理解这些细节对编写程序，哪怕是Go程序，都是很有帮助的。另一方面，对于公司，如果是为了建立一个“铁打的营盘”，组建一个不同技能等级的团队，充分利用已有的社区力量，简化工程复杂性的话，Go是目前更好的选择。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://air.googol.im/tags/rust/>Rust</a></li><li><a href=https://air.googol.im/tags/go/>Go</a></li></ul><nav class=paginav><a class=prev href=https://air.googol.im/posts/neovim-configuration/><span class=title>« Prev</span><br><span>组织Neovim配置的方法</span>
</a><a class=next href=https://air.googol.im/posts/what-i-want-in-go2-type-system/><span class=title>Next »</span><br><span>我对Go 2类型系统的期望</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 一个Go开发者的Rust体验 on x" href="https://x.com/intent/tweet/?text=%e4%b8%80%e4%b8%aaGo%e5%bc%80%e5%8f%91%e8%80%85%e7%9a%84Rust%e4%bd%93%e9%aa%8c&amp;url=https%3a%2f%2fair.googol.im%2fposts%2frust-view-from-a-gopher%2f&amp;hashtags=rust%2cgo"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 一个Go开发者的Rust体验 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fair.googol.im%2fposts%2frust-view-from-a-gopher%2f&amp;title=%e4%b8%80%e4%b8%aaGo%e5%bc%80%e5%8f%91%e8%80%85%e7%9a%84Rust%e4%bd%93%e9%aa%8c&amp;summary=%e4%b8%80%e4%b8%aaGo%e5%bc%80%e5%8f%91%e8%80%85%e7%9a%84Rust%e4%bd%93%e9%aa%8c&amp;source=https%3a%2f%2fair.googol.im%2fposts%2frust-view-from-a-gopher%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 一个Go开发者的Rust体验 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fair.googol.im%2fposts%2frust-view-from-a-gopher%2f&title=%e4%b8%80%e4%b8%aaGo%e5%bc%80%e5%8f%91%e8%80%85%e7%9a%84Rust%e4%bd%93%e9%aa%8c"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 一个Go开发者的Rust体验 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fair.googol.im%2fposts%2frust-view-from-a-gopher%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 一个Go开发者的Rust体验 on whatsapp" href="https://api.whatsapp.com/send?text=%e4%b8%80%e4%b8%aaGo%e5%bc%80%e5%8f%91%e8%80%85%e7%9a%84Rust%e4%bd%93%e9%aa%8c%20-%20https%3a%2f%2fair.googol.im%2fposts%2frust-view-from-a-gopher%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 一个Go开发者的Rust体验 on telegram" href="https://telegram.me/share/url?text=%e4%b8%80%e4%b8%aaGo%e5%bc%80%e5%8f%91%e8%80%85%e7%9a%84Rust%e4%bd%93%e9%aa%8c&amp;url=https%3a%2f%2fair.googol.im%2fposts%2frust-view-from-a-gopher%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 一个Go开发者的Rust体验 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e4%b8%80%e4%b8%aaGo%e5%bc%80%e5%8f%91%e8%80%85%e7%9a%84Rust%e4%bd%93%e9%aa%8c&u=https%3a%2f%2fair.googol.im%2fposts%2frust-view-from-a-gopher%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//air-g.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://air.googol.im/>Air On G</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>